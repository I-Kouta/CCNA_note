# Cisco IOSの接続診断ツール
pingとtracerouteコマンドの操作について

### `ping`
**pingコマンド**を使用すると特定のノードとIP通信が可能かどうかを確認できる。指定したアドレスに対してICMPのエコー要求パケットを送信し、宛先からエコー応答が送信されるのを待機する。その結果によって宛先とのネットワーク接続の診断を行う。pingコマンドでは定義した時間内にエコー要求パケットが宛先に到着し、エコー応答を受信した場合にのみpingが成功したと判断される。ping実行時に表示される記号は下記の通り。

**pingコマンド(mode:#, >)**  
`#ping | <ip-address> | <hostname> |`

ip-address:接続性を確認する宛先のIPアドレスを指定  
hostname:接続性を確認する宛先のホスト名を指定

|引数|説明                                                                                              |
|---|--------------------------------------------------------------------------------------------------|
|!  |ICMPエコー応答を受信、ping成功                                                                        |
|.  |ICMPエコー応答を受信できずに時間が経過しタイムアウト。デフォルトは2s                                         |
|U  |ICMP宛先到達不能(Destination Unreachable)を受信。転送途中にあるルータに問題があり、ルーティングできない可能性あり|
|Q  |ICMP送信元抑制(Source Quench)を受信。宛先がビジー状態                                                    |
|M  |フラグメンテーションに失敗                                                                              |
|?  |パケットタイプが不明                                                                                   |
|&  |ICMP時間超過(Time Exceeded)を受信。ICMPエコーは破棄された                                                 |

### `拡張ping`
ルータから通常のpingコマンドを実行した場合、パケットの送信元アドレスは出力インターフェイスのIPアドレスになる。pingコマンドの後ろに引数を指定しないで実行すると**拡張ping**を開始する。これを使用するとパケットの送信元IPアドレスをルータ上の任意のIPアドレスに変更したり、送信するパケット数やサイズの変更、タイムアウト時間を変更したりすることができるため、より高度な検証を行うことができる。このコマンドは**特権EXECモードで動作する**。拡張pingコマンドで変更できる項目(フィールド)は以下の通り。  
・プロトコルの指定・pingの宛先ノードをアドレスまたはホスト名で指定・送信するパケットの数・パケットのサイズ・タイムアウト間隔・追加コマンドの指定・応答データの検証・データパターン・IPヘッダオプション指定・など

### `traceroute`
パケットが宛先に到着するまでの経路(通過するルータ)を確認することができる。IOSでは、tracerouteにUDPデータデータグラムを利用してIPヘッダ内のTTL値を1ずつ増加させながら指定したアドレスまでの経路を確認する。宛先途中のルータは、TTL値が0になるとICMP時間超過メッセージを送信し、最終の宛先ではICMPポート到達不能メッセージを送信してトレースが終了したことを通知する。tracerouteコマンドを実行したデバイスは、受け取ったICMP時間超過メッセージの送信元アドレスを記録し、結果によってパケットが到達するまでに使用した経路を確認する。

**tracerouteコマンド(mode:#, >)**  
`#traceroute | <ip-address> | <hostname> |`

ip-address:宛先までの経路をトレースする宛先のIPアドレスを指定  
hostname:宛先までの経路をトレースする宛先のホスト名を指定

|引数|説明                                                                 |
|---|---------------------------------------------------------------------|
|msec  |トレース成功、隣接ルータからICMP時間超過メッセージを受信するまでにかかった時間|
|*  |2秒以内にICMP時間超過メッセージを受信できずにタイムアウト                    |
|A  |管理上の理由によってパケット転送が禁止された                                |
|Q  |ICMP送信元抑制(Source Quench)を受信。宛先がビジー状態                     |
|I  |ユーザによるテストの中断                                                |
|U  |ICMPポート到達不能(Port Unreachable)を受信                             |
|H  |ICMPホスト到達不能(Host Unreachable)を受信                             |
|N  |ICMPネットワーク到達不能(Net Unreachable)を受信                         |
|P  |ICMPプロトコル到達不能(Protocol Unreachable)を受信                      |
|T  |タイムアウトした                                                       |
|?  |パケットタイプが不明                                                    |

トレースが成功したときには「~msec」と3回分のラウンドトリップ(RTT)値が表示される。ICMP時間超過メッセージを受信できなかった場合は「*」が表示される。IP通信できない宛先に対してtracerouteを実行すると、タイムアウトが30行表示されるまで終了しない。Cisco IOSでtracerouteコマンドを中止するには、Ctrl + Shift + 6キーを押す。  
ドメイン名検索を有効にしている場合、各IPアドレスと名前を一致させようとするためtracerouteコマンドに時間がかかる場合がある。ドメイン名検索を無効にするには、グローバルコンフィギュレーションモードから**no ip domain-lookup**を使用する。

---
> トレースルートのコマンドはWindowsのコマンドプロンプトとIOSで異なる  
> Windows:tracert  
> IOS:traceroute
