# VLANの動作

### `VLANの動作`
VLANは**VLAN ID**という番号によって識別される。CatalystスイッチにはデフォルトでVLAN1がdefaultという名前で生成されており、これを**デフォルトVLAN**と呼ぶ。スイッチの全てのイーサネットポートには、デフォルトでVLAN1が割り当てられている。デフォルトVLANは削除できない。スイッチのポートにVLANを割り当てることを**VLANメンバーシップ**と呼ぶ。スイッチはブロードキャストフレームを受信すると、受信ポートと同じVLANが割り当てられているポートだけにフラッディングする。

### `スイッチポートの種類`
**スイッチポート**とは、レイヤ2専用の物理ポートを指す。L2スイッチの全ての物理ポートはスイッチポートであり、1つまたは複数のVLANに所属する。L3スイッチ(マルチレイヤスイッチ)の場合、スイッチの物理ポートはレイヤ2処理を行うスイッチポートやレイヤ3処理を行うルーティッドポートにすることができる。アクセスポートとトランクポートがある。

- アクセスポート  
1つのVLANを割り当てることができ、そのVLANのフレームのみを転送する。アクセスポートで着信したトラフィックは、そのポートに割り当てられているVLANに所属するとみなされる。一般的にクライアントPCやサーバが接続されるポートはアクセスポートとして使用する。アクセスポートにVLANを割り当てる方法は2つ。  
・スタティックVLAN:ポートにVLANを手動で割り当てる  
・ダイナミックVLAN:VMPSによって動的にVLANが割り当てられる  
**スタティックVLAN**(ポートベースVLAN)は、管理者が各ポートにVLANを割り当てる方式。接続されたノードは、そのポートに割り当てられているVLANに所属する。接続する物理ポートを変更すると、所属するVLANも変わる可能性がある。  
**ダイナミックVLAN**(MACベースVLAN)は、ポートで着信したフレームの送信元MACアドレスに基づいてVLANを動的に割り当てる方式。MACベースのダイナミックVLANを利用するには、MACアドレスとVLANのマッピング情報を保持する**VMPS**(*VLAN Management Policy Server*)というサーバが必要。  
他に、IEEE 802.1x認証を利用して認証されたホストを特定のVLANに割り当てる方式などがある。

- トランクポート  
**トランクポート**には複数のVLANを割り当てることができ、複数のVLANのフレームを転送する。トランクポートから送信されるフレームには、タグというVLAN識別情報が挿入される。フレームの受信側では挿入されたタグを参照し、「どのVLANのポートにフレームを転送すべきか」を決定する。一般的にスイッチやルータなどのネットワーク機器が接続されるポートはトランクポートとして使用される。スイッチ間をアクセスポートで接続した場合、VLANの数だけスイッチ間を接続するためのスイッチポートが必要になる。トランクポートの場合、トランクポートの場合はVLANの数とは関係なしにスイッチ間を接続するためのスイッチポートは最低1つだけで済む。

- IEEE 802.1Q  
トランクは、1本の物理リンク上で複数のVLANトラフィックを伝送する技術。**IEEE 802.1Q**は、トランクポートからフレームを送信する際にVLAN IDなどの識別情報を挿入する方法などを規定した標準プロトコルで、フレームにタグを挿入し、FCSには再計算した値をセットしてから送信する。標準イーサネットフレームのタイプor長さ(2バイト)を、タグ(TPID, プライオリティ, CFI, VID, 計4バイト)にセットする。  
・TPID(16ビット):*Tag Protocol Identifier*。タグが挿入されたフレームであることを受信側に通知。イーサネットの場合は0x8100が入る  
・プライオリティ(3ビット):フレームの優先度を指定。詳細はIEEE 802.1Qで規定されている  
・CFI(1ビット):*Canonical Format Indicator*。MACアドレスの形式を示す値。トークンリングで使用され、イーサネットの場合は0  
。VID(12ビット):*VLAN Identifier*。フレームが所属するVLANの番号が入る

- ネイティブVLAN  
IEEE 802.1Qにある機能。トランクリンクではタグを挿入することで受信側でVLANトラフィックを区別しているが、ネイティブVLANのフレームはタグを挿入せずにそのまま送信する。トランクポートでタグなしのフレームを受信すると、ネイティブVLANのからのトラフィックであると認識されるため。トランクリンクの両端でネイティブVLAN番号を一致させておく必要がある。両端でネイティブVLAN番号が異なると、意図しないVLANにフレームが転送されてしまう。ネイティブVLANはトランクポートごとに番号を指定することが可能で、デフォルトのネイティブVLANは1。  
CDPやDTPなどの管理トラフィックはVLANの定義とは関係なく、トランクポートからタグなしフレームで送信される。Catalystスイッチは、CDPを使用してネイティブVLANの不一致を警告する。

### `管理VLAN`
**管理VLAN**は、リモートからスイッチをTelnetやSNMPで管理するための仮想的なVLAN。CatalystスイッチはデフォルトでVLAN1が管理VLANに設定されている。

- 管理インターフェイス  
スイッチには管理VLAN用に用意された仮想的な**管理インターフェイス**がある。IPアドレスを割り当てることで、スイッチ自身がTCP / IP通信を行うことができる。L2スイッチでは、トラフィックの識別をIPサブネット単位でなくVLAN単位で行う。interface vlanコマンドを使用して、管理インターフェイスを「管理VLANインターフェイス」として構成する。1台のスイッチで複数の管理VLANインターフェイスを作成することができるが、管理VLANインターフェイスを同時に複数有効化することはできない。

---
> CCNA Routing and Switchingでは、スタティックVLANの設定がポイント。ダイナミックVLANにはVMPSが必要で、どのPCを接続しても適切なVLANに所属できる。

> CDPは、ネイティブVLAN(タグなしフレーム)で送信される。
