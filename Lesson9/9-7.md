# VLAN間ルーティング
VLANはレイヤ2のレベルで論理的にネットワークを分割する技術。異なるVLANに所属するホスト間の通信にはルーティングデバイスが必要になる。

### `VLAN間ルーティングの概要`
VLAN間で接続をする行には、ルーティングデバイス(ルータまたはL3スイッチ)を使用して相互に接続する必要がある。ルーティングはIPアドレスを基に行われるため、各LANにはそれぞれネットワークアドレスを割り当てる必要がある。  
ルータはルーティングテーブルに直接接続ネットワークを登録する。各サブネットのホストは、外部ネットワークと通信するためのデフォルトゲートウェイとして、自身のサブネットを接続しているルータインターフェイスに割り当てられているIPアドレスを指定する。VLAN間を相互に接続する場合も同じような環境が必要になり、ルーティングの実装には「ルータを使用」「L3スイッチ(レイヤ3スイッチ)を使用」を行う。

### `ルータを使用したVLAN間ルーティング`
L2スイッチのアクセスポートとルータのインターフェイスを接続する構成。ルータのFa0/0インターフェイスをVLAN1のアクセスポートと接続し、Fa0/1インターフェイスをVLAN2のアクセスポートと接続することができる。ただ、この構成だとVLANと同じ数のスイッチポートとルータインターフェイスが物理的に必要になり、スケーラブル(拡張性)ではない。この問題は、スイッチのトランクポートとルータのインターフェイスを接続することで解決する。この場合はルータに必要なインターフェイスは1つだけ。L2スイッチで作成したVLAN間をトランクポートで接続した外部ルータでルーティングする構成をシスコでは**Router on a stick**と呼ぶ。  
この構成はL2スイッチやルータをそのまま利用できる点。安価で設定が容易なスイッチとルータを使用してVLAN間の相互通信が実現可能。反面、スイッチとルータ間のトランク接続がシングルトラフィックパスになることで、遅延が発生する(L3スイッチの使用で解決)。  
1.VLAN1のPCからスイッチへパケットが届く  
2.スイッチはトランク経由でルータへパケットを転送する  
3.ルータは受信したパケットをルーティングする  
4.ルータはトランク経由でスイッチへパケットを転送する  
5.スイッチはVLAN2のPCへパケットを転送する  
ルータでVLAN間ルーティングを行うため、トラフィックが同じトランクリンクを通ることで混雑し、通信に遅延が発生する可能性がある。L3スイッチを使用すると、これらの機能は1台の機器で提供されるためパケットはより高速に処理できる。

- Router on a stickの設定  
次の3つの構成要素に対して設定を行う。  
ルータ:サブインターフェイスの設定  
スイッチ:トランク設定の設定  
PC:デフォルトゲートウェイの設定  
ルータとスイッチ間のトランクプロトコルにはIEEE 802.1Qを使用する。シスコ独自のISLでRouter on a stickを構成することも可能だが現在はIEEE 802.1Qが主流。  
ルータの物理インターフェイスには**サブインターフェイス**を設定する。サブインターフェイスは、1つの物理インターフェイスを論理的に複数に分割するための仮想的なインターフェイスのこと。ルータの1つの物理インターフェイスをVLANの数だけサブインターフェイスに分割し、それぞれにVLAN IDとIPアドレスを割り当てる。以下がその手順。  
1.サブインターフェイスの作成  
2.トランクプロトコルとVLAN IDの指定  
3.IPアドレスの割り当て

1.**interface \<interface-id>**コマンドの後にドットと1番以降の整数を指定する。これでサブインターフェイスのコンフィギュレーションモードへ移行する。作成したサブインターフェイスを削除するには先頭にnoを付けて再起動。サブインターフェイスとVLAN IDは1対1で割り当てるため、VLANと同じ数のサブインターフェイスを作成する。サブインターフェイスの番号とVLAN IDは揃っている必要はない。  
**サブインターフェイスの作成**  
`(config)#interface <interface-id>.<subinterface number>`  
`(config-subif)#`  
subinterface number:サブインターフェイスの番号を1 ~ 4294967293の範囲で指定

- Router on a stickの検証

- ルータの検証

- スイッチの検証

- PCの検証

### `L3スイッチを使用したVLAN間ルーティング`

- L3スイッチを使用したVLAN間ルーティングの設定

---
> Router on a stickは、ルータ1つのインターフェイスを使用して複数のサブネット間のルーティングを行う
