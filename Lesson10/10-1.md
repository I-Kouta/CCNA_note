# IPv4アクセスリストの概要
アクセスリストは、ルータを通過するパケットの転送を条件によって許可したり拒否したりしたりするパケットフィルタリングや、NATやVPN接続などの処理でパケットを分類するなど様々な用途で使用する。

### `ACLとは`
**アクセスリスト**(ACL:*Access Control List*)は、トラフィックを識別し制御するための条件を記述したリスト。管理者の定義した要件でACLを作成しルータのインターフェイスを適用すると、パケットがルータを通過する際にACLと照合される。パケットはACLの許可の条件に一致した場合のみ転送され、それ以外のパケットの転送は拒否する。ACLのパケットフィルタリングの実装によって、特定のホストがネットワーク上のどのノードにアクセスできるかを制御したり、トラフィックの種類ごとに転送の許可・拒否するかを指定できるため、ネットワークの基本的なセキュリティを確保できる。

### `ACLの種類`
ACLには標準ACLと拡張ACLの2種類がある。

- 標準ACL  
標準ACLは、条件として**送信元IPアドレスだけ**を指定できる。標準ACLの照合では、**パケットのIPヘッダ内にある送信元IPアドレスのみ**チェックされ、パケット転送の許可・拒否が決定される。

- 拡張ACL  
拡張ACLは、条件として**送信元IPアドレスと宛先IPアドレスの両方**を指定できる。さらに**プロトコル、送信元ポート番号、宛先ポート番号**も指定できる。拡張ACLの照合では、パケットのIPヘッダおよびTCP / UDPヘッダ内の複数の条件に基づいてパケット転送の許可・拒否が決定されるため、柔軟で複雑な制御ができる。送信元IPアドレスと宛先IPアドレス、プロトコルはIPヘッダ(レイヤ3・ネットワーク層)、送信元ポートと宛先ポートはTCP / UDPヘッダ(レイヤ4・トランスポート層)にある。

### `ACLの識別方法`
ACLはIPX、AppleTalkなど様々なネットワーク層のプロトコルに対応している。ACLを識別するには、番号で識別する方法と名前で識別する方法の2つ。

- `番号付きACL`
番号を指定されている作成するACLのこと。IOSではネットワーク層プロトコルの種類と標準 / 拡張ACLを番号で識別する。

|プロトコルの種類|ACL番号               |
|--------------|---------------------|
|IPv4標準       |1 ~ 99, 1300 ~ 1999  |
|IPv4拡張       |100 ~ 99, 2000 ~ 2699|
|AppleTalk     |600 ~ 699            |
|IPX標準        |800 ~ 899            |
|IPX拡張        |900 ~ 999            |

- `名前付きACL`  
名前を指定して作成すACLのこと。作成時に任意の名前、プロトコル、標準 / 拡張を指定する。FTPトラフィックを制御する場合は「FTP-Filter」とするなど、目的に合った名前でACLを作成すると管理しやすい。IPv6ではACLのみサポートしている。

### `ACLの適用`
インターフェイスにACLを適用することで、そのインターフェイスでパケットを着信・発信するときにACLと照合し、パケットフィルタフィングの機能を果たす。ACLはネットワーク層のプロトコルごとにインターフェイスの着信・発信の各方向に1つずつ適用できる。1つのACLを複数のインターフェイスに適用することもできる。  
ルータのFa0 / 0のインバウンドにIPv4 ACLとIPv6 ACLの両方を適用できる。ネットワーク層プロトコルが異なるため、IPv4パケットを着信したときはIPv4 ACLと照合し、IPv6パケットを着信した時にはIPv6 ACLと照合する。ただし、Fa0 / 1のインバウンドにIPv4標準ACLとIPv4拡張の両方を適用することはできない。ネットワーク層プロトコルが同じであるため、IPv4パケットの着信時に標準・拡張のどちらのACLと照合すれば良いか判断できない。

### `インバウンドACLとアウトバウンドACL`
ACLをインターフェイスのインバウンドとアウトバウンドのどちらに適用するかによって動作は異なる。

- インバウンドACL  
ルータはパケットを受信するとインターフェイスに適用されたインバウンドACLのエントリと照合する。ACLの許可に条件に一致したパケットは、通常のルーティング処理を決定する。拒否の条件に一致したパケットは破棄される。

- アウトバウンドACL  
ルータは受信したパケットの宛先IPアドレスを基にルーティングテーブルを参照し、発信インターフェイスを決定すると、そのインターフェイスに適用されたアウトバウンドACLのエントリと照合する。ACOの許可の条件に一致したパケットは転送され、拒否の条件に一致したパケットは破棄される。インバウンドでパケットフィルタリングを行うと拒否されたパケットのルーティング処理は必要なくなるため、ルータ負荷を軽減できる

### `ACL設定の注意事項`
ACLの条件に誤りがあると必要なパケットまで破棄されてしまう可能性がある。以下の注意が必要。  
・ステートメントの順番  
・暗黙のdenyの存在  
・適用インターフェイス  
・ACLの配置  
・フィルタリングの対象パケット

- ステートメントの順番  
ACLに含まれる1行の条件分を**ステートメント**と呼ぶ。各ステートメントにはシーケンス番号(行番号)を指定できる。シーケンス番号を省略してステートメントを作成した場合、1つ目のステートメントは自動的に10番になり、2行目以降は10ずつ加算された番号が割り当てられる。ステートメントの条件と一致したパケットはその時点で許可・拒否の処理が行われ、以降のステートメントは無視される。そのためステートメントの順番が重要となる。下記の順番の場合、10番のステートメントに一致して拒否される。20番(サブネット)は無視されるため、限定された条件ほど上に置く必要がある。

|番号|送信元IP      |処理|
|---|-------------|---|
|10 |172.16.1.1   |拒否|
|20 |172.16.1.0/24|許可|

- 「暗黙のdeny」の存在  
ACLの末尾には全てのパケットを暗黙的に拒否するステートメントが存在する。そのためACLの中には最低一つの許可(permit)ステートメントを含める必要がある。この最終ステートメントは**暗黙のdeny**(**暗黙の拒否**)と呼ばれる。このステートメントはshowコマンドで表示されない。

- 適用インターフェイス  
ACLをインターフェイスに適用することで、パケットフィルタリングとして機能する。このときトラフィックの流れを確認し、ACLを適切なインターフェイスに適用するよう注意が必要。  
要件:172.16.1.2のみ外部ネットワーク(S0 / 0 / 0)へのアクセスを禁止

|番号|送信元IP      |処理|
|---|-------------|---|
|10 |172.16.1.2   |拒否|
|20 |any(全て)     |許可|

この場合172.16.1.2から外部ネットワークへアクセスするパケットは、ステートメント10番の条件に一致して拒否されるが、172.16.1.2からFa0 / 1側のサーバ宛のパケットも10番の条件に一致して拒否される。今回の条件を満たすには、ACL1のS0 / 0 / 0のアウトバウンドに適用する必要がある。

- ACLの配置  
ネットワーク上に複数のルータが存在する時、ACLをどのルータに配置するかの選択が必要。  
要件:172.16.1.1からのパケットだけ、172.16.4.1へのアクセスを禁止する  

拡張ACL:送信元に近い場所に配置する  
|番号|送信元IP      |宛先IP    |処理|
|---|-------------|----------|---|
|10 |172.16.1.1   |172.16.1.1|拒否|
|20 |any          |any       |許可|

標準ACL:パケットの宛先近くに配置する  
|番号|送信元IP      |処理|
|---|-------------|---|
|10 |172.16.1.1   |拒否|
|20 |any          |許可|

標準ACLでは条件に送信元IPアドレスしか指定できないため、標準ACLは**パケットの宛先近くに**配置する必要がある。拡張ACLでは、条件に送信元IPアドレスと宛先IPアドレスの両方を指定することが可能なため、どちらのルータに配置しても要件を満たすパケットフィルタリングが可能。ただし、ネットワーク上に無駄なトラフィックが流れ帯域幅を浪費する可能性があるため、できるだけパケットの**送信元に近くに**配置することで、余計なオーバーヘッドを軽減できる。

- フィルタリングの対象パケット  
ACLによるパケットフィルタリングでは、ルータを通過するパケットだけがフィルタリングの対象になる。ルータ自身から発信されるパケット(送信元がルータ自身のパケット)はフィルタリング対象とみなさない。ルータにICMPメッセージを拒否する条件の拡張ACLを作成しても、ルータからのpingは成功する。

---
> `番号つき標準ACL:1 ~ 99, 1300 ~ 1999`  
> `番号つき拡張ACL:100 ~ 199, 2000 ~ 2699`

> インバウンドACL:`ACL照合 => ルーティングテーブル参照`  
> アウトバウンドACL:`ルーティングテーブル参照 => ACL照合`

> ACLの最終行には必ず暗黙のdenyが存在する。`permit`行が最低1行必要

> 標準ACL:`パケットの宛先近くに配置`  
> 拡張ACL:`パケット送信元近くに配置`
