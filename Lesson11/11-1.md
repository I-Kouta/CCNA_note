# DHCPによるインターネット接続
DHCPサービスは、ネットワーク上のデバイスがDHCPサーバからIPアドレスとその他の設定情報を取得できるようにするためのもの。ポート番号67, 68、UDP、コンピュータがネットワーク接続時に必要となるIPアドレスなどの情報を自動的に割り当てる。

### `DHCPクライアント`
DHCPサービスによって、クライアントはIPアドレス、サブネットマスク、デフォルトゲートウェイ、その他のパラメータを自動的に取得できる。ISP(インターネットサービスプロバイダ)は、インターネットに接続される顧客の各インターフェイスに対して。静的または動的なグローバルIPアドレスを割り当てる。  
スタティックIPアドレス:常に同じIPアドレスが静的に割り振られる。固定IPアドレスとも呼ばれる  
ダイナミックIPアドレス:インターネットへ接続するごとに異なるIPアドレスが動的に割り振られる

- スタティックIPアドレスの設定  
**スタティックIPアドレス**(**固定IPアドレス**)を使用すると、WebやFTPなどの公開サーバの設置や、VPNによる拠点同士の接続など。固定IPアドレスを必要とするサービスを利用できる。ISPによって割り当てられたスタティックIPアドレスなどをCiscoルータに設定するには通常2つの手順が必要。</br>
1.スタティックIPアドレスの設定:ルータの外部インターフェイスにスタティックIPアドレスを設定する  
2.デフォルトルートの作成:インターネットへ向かうデフォルトルートを設定する

- DHCPクライアントの設定  
ISPからダイナミックIPアドレスを取得する場合、インターネットインターフェイスはDHCPクライアントとして動作するように設定する。Ciscoルータでは**ip address dhcp**コマンドを設定すると、そのインターフェイスがDHCPによってIPアドレスを取得できるようになる。割り当てられたIPアドレスと共に受信したDHCPオプションのデフォルトゲートウェイに基づいて、そのデフォルトゲートウェイを指すデフォルトルートが自動的にルーティングテーブルに挿入される。  
**DHCPクライアントの設定**  
`(config-if)#ip address dhcp`

- DHCPクライアントのリース情報の表示  
**show dhcp lease**コマンドは、DHCPクライアントに割り当てられたIPアドレスのリース情報を表示する(リース残り時間)。  
**リース情報を表示(mode:#)**  
`#show dhcp lease`

### `DHCPサーバ`
DHCPサーバによる動的なIPアドレスの割り当ては、以下のような場面で必要になる。  
インターネット接続:インターネットへの接続が必要な時に、ISPから動的にグローバルIPアドレスを取得する場合  
企業などのLAN:中・大規模LANで、従業員のPCにIPアドレスや設定情報を動的に割り当てるような場合  
モバイル(携帯可能なシステム):オフィスの共用部、飲食店や宿泊施設などで各自のノートPCをLANへ接続するような場合  
PCの台数が少なければIPアドレスの手動割り当ては許容されるが、それ以上のLANで個々のPCにIPアドレスを手動で割り当てたり時折オフィスに出社するモバイルワーカーにIPアドレスを手動で割り当てたりするのは管理上負担がかかり困難。設定を誤る可能性もある。ローカルネットワークにDHCPサーバを導入することで、IPアドレスの割り当てを簡素化できる。一般に、DHCPサーバはネットワークにおける頻繁な変更をサポートし、LANに接続されるゲストホストへ適切なIPアドレスを割り当てるのに使用される。ホストのVLAN割り当てに従って、IPアドレスを自動的にエンドホストに割り当てることもできる。集中型のDHCPサーバでは、全てのダイナミックIPアドレスの割り当てを1ヶ所で管理し、組織全体に一貫性を確保できる。

- DHCPの動作  
DHCPサーバでは、メッセージ交換によってIPアドレスや設定情報を動的に割り当てる。  
1.DISCOVER:クライアントはDISCOVERメッセージをブロードキャスト(同一ネットワークの全ノードに向けて送信)し、使用可能なDHCPサーバを検出する。DHCPクライアントからDHCPサーバへのメッセージ。  
2.OFFER:サーバはDISCOVERを受信すると、クライアント候補となるIPアドレスを予約してOFFERメッセージをクライアントに送信する。DHCPサーバからDHCPクライアントへのメッセージ。  
3.REQUEST:クライアントはOFFERを受信すると、IPアドレスを受け入れる意思を示すために、REQUESTメッセージをブロードキャストする。DHCPクライアントからDHCPサーバへのメッセージ。  
4.ACK:サーバはREQUESTを受信すると、ACKメッセージを使用してクライアントの要求に応答する。このパケットには要求された全てのパラメータが含まれる。DHCPサーバからDHCPクライアントへのメッセージ。

- DHCPサーバの設定  
Cisco IOSはDHCPサーバとしての機能を全て備えており、CiscoルータおよびCatalystスイッチをDHCPサーバとして動作させることが可能。DHCPサーバの設定手順とコマンドは以下の通り。  
1.DHCPプールの作成  
2.ネットワークアドレスの指定  
3.デフォルトゲートウェイの指定  
4.DHCPオプションの設定  
5.リース期間の設定(オプション)  
6.除外するIPアドレスの指定

1.DHCPプールの設定  
DHCPサーバは、定義されたアドレス範囲から個々のクライアントに重複しないようにIPアドレスを配布する。この予め蓄えておくアドレス範囲を**DHCPプール**と呼ぶ。作成には**ip dhcp pool**コマンドを使用する。これでDHCPコンフィギュレーションモードが開始され、DHCPプールに対して各種パラメータの定義が可能になる。  
**DHCPプールの作成**  
`(config)#ip dhcp pool <pool-name>`  
`(dhcp-config)#`  
pool-name:プールの識別情報として文字列または番号を指定

2.ネットワークアドレスの指定  
**network**コマンドを使用して、DHCPクライアントのネットワークアドレスとマスクを指定する。指定したネットワークアドレスに対応するホストアドレスの範囲がクライアントへ配布される。  
**ネットワークアドレスの指定**  
`(dhcp-config)#network <network> [<subnet-mask> | </prefix-length>]`  
network:DHCPプールのネットワークアドレスを指定  
subnet-mask|/prefix-length:サブネットマスクまたはプレフィックス長を指定するオプション。省略時にはナチュラルマスクが適用される  
ナチュラルマスク:クラスに基づいたサブネットマスク(デフォルトマスク)。クラスAなら255.0.0.0、クラスBなら255.255.0.0、クラスCなら255.255.255.0

3.デフォルトゲートウェイの指定  
DHCPクライアントに通知するデフォルトゲートウェイを指定するには、**default-router**コマンドを使用する。  
**デフォルトゲートウェイの指定**  
`(dhcp-config)#default-router <ip-address1> [<ip-address2> … <ip-address8>]`  
ip-address:デフォルトゲートウェイを指定(最大8つ)

4.DHCPオプションの指定  
DHCPでは、IPアドレスとデフォルトゲートウェイの他に、ドメイン名(インターネット上でIPアドレスの代わりに使用する。サイトや電子メールのアドレスに使われる)やDNSサーバなどの設定情報をクライアントに配布できる。  
**ドメイン名の指定**  
`(dhcp-config)#domain-name <word>`  
word:任意のドメイン名を指定  
**DNSサーバの指定**  
`(dhcp-config)#dns-server <ip-address1> [<ip-address2> … <ip-address8>]`  
ip-address:デフォルトゲートウェイを指定(最大8つ)

5.リース期間の指定  
DHCPサーバから払い出されたIPアドレスの有効期限を**lease**コマンドで設定する。設定省略した場合はデフォルトの24時間が設定される。  
**リース期間の指定(オプション)**  
`(dhcp-config)#lease {<days> | [<hours>] [<minutes>] | infinite}`  
days:日数を0 ~ 365の範囲で指定(デフォルトは1)  
hours:時間を0 ~ 23の範囲で指定(オプション)  
minutes:分を0 ~ 59の範囲で指定(オプション)  
infinite:無制限に使用可能となる

6.除外するIPアドレスの指定  
DNSサーバやデフォルトゲートウェイ(ルータ)のIPアドレスを、クライアントに割り当てないように除外する必要がある。DHCPサーバがDHCPクライアントに割り当てるアドレス範囲から除外するIPアドレスを指定するには、グローバルコンフィギュレーションモードから**ip dhcp excluded-address**コマンドで設定する。除外するIPアドレスは、単一または範囲で指定できる。  
**除外するIPアドレスの指定**  
`(config)#ip dhcp excluded-address <ip-address> [<last-ip-address>]`  
ip-address:除外するIPアドレスを指定。範囲で指定する場合は先頭のアドレスを指定  
last-ip-address:範囲で指定する際の最終アドレスを指定(オプション)

- DHCPサーバ機能の検証  
DHCPサーバ機能の確認には、以下のコマンドを使用する。  
`show ip dhcp pool`  
`show ip dhcp binding`  
`show dhcp lease`  
`show ip dhcp conflict`  
設定例:DHCPクライアント, PC --- スイッチ(PC2台) --- DHCPサーバ(スイッチ), Fao(172.16.10.254)  
DHCPプール:LANUser, 172.16.10.0 / 24, 172.16.10.101 ~ 254は除外

- DHCPプールの表示  
**show ip dhcp pool**コマンドは、設定したDHCPプールに関する情報を表示する。Total address(合計アドレス)の数は、除外したIPアドレスの数は引かれない。合計アドレスとリースされたアドレス数、次に割り当てるアドレスやアドレス範囲も表示される。  
**DHCPプールの表示(mode:>, #)**  
`#show ip dhcp pool [<pool-name>]`  
pool-name:一部のプールのみ表示したいときにはプール名を表示

- アドレスバインディング情報の表示  
**アドレスバインディング**は、DHCPによって提供されたIPアドレスとMACアドレスを対応付けたマッピング情報。クライアントのIPアドレスは、管理者が手動で割り当てることも、DHCPサーバでプールから自動で割り当てることも可能。自動バインディングを設定しておくことで、DHCPによって検出されたクライアントのMACアドレスとリースしたIPアドレスが自動的にマッピングされる。どのIPアドレスがどのクライアントがどのクライアント(MACアドレス)へ貸し出されたかを確認するためには、**show ip dhcp binding**コマンドを使用する。IPアドレス、MACアドレス、リース失効期間、割り当てタイプが表示される。  
**アドレスバインディングの表示(mode:>, #)**  
`#show ip binding [<ip-address>]`  
ip-address:指定したIPアドレスと関連付けられたMACアドレスを表示するオプション

- アドレス競合の表示  
**show ip dhcp conflict**コマンドは、DHCPサーバによって検出されたアドレス競合を表示する。DHCPプールで空き状態として認識しているにも関わらず、サブネット上の端末は既に割り当てられている場合にアドレス競合が発生する。DHCPサーバは競合の検出にpingを検出し、DHCPクライアントGratuitous ARPを使用する。アドレス競合を検出すると、そのアドレスはプールから取り除かれ、管理者が競合を解決するまで割り当てられない。競合するIPアドレスを消去するには、特権EXECモードから**clear ip conflict \<ip-address>** コマンドを実行する。競合したアドレスの他に、競合の検出方法、検出された時刻が表示される。  
**アドレス競合の表示(mode:>, #)**  
`#show ip dhcp conflict`

### `DHCPクライアントの確認`
DHCPクライアントで、IPアドレスやDHCP設定情報を取得できたかどうか確認する。Windows PCの場合、**ipconfig/all**コマンドを実行する。

### `DHCPリレーエージェントの設定`
DHCPサービスは同一ブロードキャストドメイン内で機能する。ただ、現在の企業LANでは、サーバはサーバルームへ一括して配置され、クライアントサブネットとサーバサブネットを分けて分割するのが一般的。クライアントPCが配置される様々な場所に配置すると、サーバの管理作業が複雑になり人為的なトラブルが発生する可能性も高まる。集中型のDHCP構成において、クライアントから送信されるDHCP DISCOVERメッセージはブロードキャストであるため、ルータ(L3スイッチ)によって転送されない。**DHCPリレーエージェント**機能(ルータが機能する)を使用すると、DHCPクライアントは異なるサブネットにあるDHCPサーバからIPアドレスを取得できるようになる。  
DHCPリレーションエージェントでは、DHCPメッセージのブロードキャストを受信すると、ユニキャストのパケットとして中継する。DHCPリレーエージェント機能を使用するには、ルータ(L3スイッチ)のインターフェイスに対して**ip helper-address**コマンドを設定する。UDPポート番号に基づいて任意のUDPブロードキャストを中継するように設定できる。大量のブロードキャストトラフィックがフラッディングされるのを抑制するために、デフォルトではTFTP(69), DNS(53), DHCP(67, 68)など一部のUDPブロードキャストのみを中継する。このコマンドは、クライアント(ブロードキャストを受信する)側のインターフェイスに対して設定する。設定の確認では、**show ip helper-address**コマンドを使用する。  
**IPヘルパーアドレスの設定(DHCPメッセージの中継)**  
`(config-if)#ip helper-address <server-address>`  
server-address:サーバのIPアドレスを指定

---
> DHCPクライアントとDHCPサーバ間で4つのメッセージをやり取りする。DISCOVERはクライアントがDHCPサーバを検出するためにブロードキャストで送信する

> DHCPのデフォルトゲートウェイのリース期間は24時間

> ipconfigは「IPに関する構成情報を表示」する。ipconfig/allでは、DHCPで取得したIPアドレスやデフォルトゲートウェイの他に、DHCPの有効(無効)、リースの有効期限、DHCPサーバのIPアドレスなどが確認できる。Windows PCがDHCPクライアントとして機能している場合、以下のオプションでトラブルシューティングに使える。  
> `ipconfig/renew`:IPアドレスのリースを更新する  
> `ipconfig/release`:DHCPサーバ取得したIPアドレスのリースを解放する

> Windowsコマンドプロンプトで使用されるコマンド  
> `ping <ip-address>`:IP(ネットワーク層)での接続状態を確認  
> `tracert <ip-address>`:宛先までの経路を確認  
> `ipconfig(またはipconfig/all)`:IPの構成情報を表示  
> `telnet <ip-address>`:リモートデバイスにログインして遠隔操作を行う  
> `arp -a`:ARPテーブルの表示  
> `nslookup`:DNSの動作状態を確認  

> DHCP DISCOVERはブロードキャストで、ルータを超えて転送されない。DHCPクライアントとDHCPサーバが同じサブネットに存在しない時、ルータは`ip helper-address`で指定した宛先(ユニキャスト)へDHCPパケットを中継する
