# NAT、PATのトラブルシューティング
NATはトランスポートのポート番号を識別子として利用する。これによって、内部のホストが1つしかないグローバルIP内部ホストを使用してインターネットへのアクセスを実現する  

### `アドレス変換できない要因`
NAT / PATで適切にアドレス変換が実行されない場合、以下のような原因が考えられる。  
・インターフェイスのinside / outside設定の不足または誤り  
・ACL設定で、変換対象パケットが全て許可されていない  
・プール設定で、アドレス範囲またはoverloadがない  
・ルーティングテーブルの問題で、パケット転送に必要な経路情報がない  
・パケットフィルタリングのACLがインターフェイスに適用されている

### `トラブルシューティング例`
- 問題1.内部ネットワークのホストがインターネットへアクセスできない  
状況:営業部20台(192.168.1.0 / 26, Fa0 / 0), 技術部20台(192.168.1.64 / 26, Fa0 / 1) --- NAT Router(S0 / 0 / 0) --- インターネット  
原因:  
・ACLの設定が誤っている、ルーティングに問題がある、プールに定義したあアドレス範囲が不足しておりoverloadがない  
ACLのステートメントが2行あり番号が異なるということは、別のACLが作成している。`ip nat inside source list`コマンドでACL1を定義しており、営業部からのパケット(192.168.1.0)しか変換対象とならない。ACL1で技術部(192.168.1.64)も変換対象に分類する必要がある。insideからoutsideへの手の転送はルーティングの後にNAT処理が行われる。コンフィギュレーションファイルではルーティングプロトコルやスタティックルートの設定がないため、ルーティングテーブルに宛先への経路情報がなくパケットが破棄されてしまうのでデフォルトルートを作成する。グローバルアドレスが4つであるため、多くの内部ホストがインターネットにアクセスできないため、`ip nat inside source list`コマンドの末尾にoverloadを付加してPATを有効にして解消ができる。  
`NAT-RO#configure terminal`:設定モードへ移行  
`NAT-RO(config)#access-list 1 permit 192.168.1.64 0.0.0.63`:ACL1に許可の条件を付与  
`NAT-RO(config)#ip route 0.0.0.0 0.0.0.0 serial 0/0/0`:デフォルトルート作成  
`NAT-RO(config)#ip nat inside source list 1 pool CCNA overload`:overload付加  
`NAT-RO#show running-config | begin ip nat pool`:設定の反映を確認

- 問題2.外部ホストがWebサーバへHTTPアクセスできない  
状況:192.168.1.0 / 26, Fa0 / 0, Webサーバ(192.168.1.100 / 26, Fa0 / 1) --- NAT Router(S0 / 0 / 0) --- インターネット  
原因:  
・インターフェイスのinside / outside設定の誤り、スタティックNATの設定の誤り  
今回の構成では、Fa0 / 0とFa0 / 1を内部ネットワークに接続し、S0 / 0 / 0を外部ネットワークに接続している。`ip nat inside`コマンドで、設定が上書きされてoutsideの設定を失くすことが可能。`ip nat inside source static`コマンド(内部送信元アドレス変換)は、先に内部ローカルアドレス、後に内部グローバルアドレスを指定する。  
`NAT-RO#interface fastethernet0/1`:Fa0 / 1の設定モードに移行  
`NAT-RO(config-if)#ip nat inside`:insideに変更する  
`NAT-RO(config-if)#ip nat inside source static 192.168.1.100 1.1.1.3`:スタティックNATの設定
