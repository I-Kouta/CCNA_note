b# IPv6アドレス
IPv6のアドレスは長はIPv4の4倍あるため、従来の表記方法で表すことが難しい。

### `IPv6のアドレス表記`
IPv6は128ビットであるためIPv4のように10進数で表記すると長い数字の羅列になってしまう。そのため、16ビットずつコロンで区切って8個のフィールドに分け、16進数で表記する。アドレス表記を短くするため、省略ルールがある。  
・各フィールドの先頭の0は省略可能  
・0のフィールドが連続する場合は「::」で1度だけ表現可能  
例:  
2001:0db8:0001:0020:0abc:0000:0000:0001 => 2001:db8:1:20:abc:0:0:1 => 2001:db8:1:20:abc::1

### `IPv6のプレフィックス`
IPv6のプレフィックスは、次の2つの用途で使用される。  
・IPv6のネットワークアドレスを表す  
・IPv6アドレスの一部で固定のビット値を表す

IPv6でネットワークアドレスを示す場合、サブネットマスクは使用しない。CIDR表記と同様、/でプレフィックスを表す。  
例:IPv6アドレスが2001:db8:1234:1::1:1/64の場合  
ネットワークアドレスは2001:db8:1234:1:: / 64  
プレフィックスはアドレス範囲を示す場合にも使用される。「2000::/3」の場合、2進数の先頭から3ビットの値が001で始まるアドレス全てを表現する。  
2000::/3 => 先頭3ビットが001で始まるアドレス  
FF80::/10 => 先頭10ビットが1111 1111 10で始まるアドレス

### `IPv6アドレスの種類`
IPv6アドレスでは、3種類のアドレスを定義している。

- ユニキャストアドレス(1対1の通信)  
1対1の通信で利用される単一インターフェイス用のアドレス。IPv4と同様に、特定のインターフェイスに割り当てられる。また、ユニキャストアドレス宛のパケットは、そのアドレスを持つインターフェイスに転送される。

- マルチキャストアドレス(1対多の通信)  
IPv4と同様に、特定のグループに対する通信(1対多)の際に宛先アドレスとして利用される。

- エニーキャストアドレス(1対多の1と通信)(最も近いノードと通信)  
エニーキャストアドレスでは、複数のノードのインターフェイスに対して同じユニキャストアドレスを割り当てる。エニーキャストアドレス宛のパケットは、そのアドレスを持つ最も近いノードのインターフェイスに転送される。

IPv6にはブロードキャストアドレスは存在しない。マルチキャストアドレスが同様の役割を果たす。

### `アドレススコープ`
IPv6のアドレスタイプには、アドレスの有効範囲を表す「スコープ」が3種類ある。  
・グローバル:  
有効範囲に制限はなく、通常はISPから取得するアドレス。インターネットを含め全IPv6ネットワークで利用できる  
・ユニークローカル:  
組織内でのみ有効なユニキャストのアドレスで、IPv4のプライベートアドレスに相当する。IPv6はアドレス空間が広大なため、内部の全ホストにグローバルアドレスを割り当てることができるので、ユニークローカルアドレスは必要に応じて割り当てる  
・リンクローカル:  
特定リンク(サブネット)でのみ有効なアドレス。リンクローカルアドレス宛のパケットはルータを超えて転送されない。アドレス自動設定やルーティングプロトコルなどで利用される

### `ユニキャストアドレス`
IPv4のユニキャストアドレスがネットワーク部とホスト部で構成されていたように、IPv6のユニキャストアドレスもネットワークを示すプレフィックス(**サブネットプレフィックス**)と、そのネットワークに接続されるホスト(インターフェイス)を示す**インターフェイスID**で構成される。IPv6のサブネットプレフィックスとインターフェイスIDの境界は固定のため、アドレス設計は容易。スコープ(有効範囲)によって、「グローバルユニキャストアドレス」「ユニークローカルユニキャストアドレス」「リンクローカルユニキャストアドレス」に分かれる。

- グローバルユニキャストアドレス(2000::/3で始まる)  
先頭3ビットが「001(2000::/3)」で始まるインターネット上で通信が可能なアドレスで、IPv4のグローバルアドレスに相当する。ISPは組織に対して「/64 ~ /48」のアドレスブロックを割り当てている。組織では1つのアドレスを基に**サブネットID**(16ビット)を使用して最大65,536個のサブネットを作成できる。サブネットIDは**SLA**(*Site Aggregation*:サイトレベル集約識別子)とも呼ぶ。グローバルルーティングプレフィックスが48ビット、サブネットIDが16ビット(サブネット識別に使用)、インターフェイスIDが64ビット。

- ユニークローカルユニキャストアドレス(FC::/7で始まる)  
インターネット上で通信できないアドレスで、IPv4のプライベートアドレスに相当する。先頭から8ビット目(L)は、グローバルIDの使用方法を指定する。0はIETFによって予約されており、通常は1。ユニークローカルユニキャストアドレスの上位8ビットは「1111 1101」となり、FD00::/8のみ利用可能。グローバルIDが41ビット、サブネットIDとインターフェイスIDは同様。

- リンクローカルユニキャストアドレス(FC::/10で始まる)  
LANケーブルなどで物理的に接続されているローカルネットワーク(サブネット)内でのみ有効なアドレスで、ルータを超えて通信できない。ノードが同一サブネット上に存在する近隣ノードと通信するときに使用される。リンクローカルユニキャストアドレスは、単に「リンクローカルアドレス」とも呼ばれる。インターフェイス上でIPv6が有効になると、リンクローカルアドレスが自動的に付与される。このとき使用されるインターフェイスIDは、MACアドレスを基にしたEUI-64フォーマットで生成される。プレフィックスが10ビット(1111 1110 10)(FE80::/10)、54ビット0が続き、インターフェイスIDは64ビット。

### `特殊なIPv6アドレス`
次のような特殊なアドレスがある。

- ループバックアドレス(::1)  
自分自身を表す特殊なアドレスで「::1(0:0:0:0:0:0:0:1)」で定義されている。IPv4の127.0.0.1に相当する。

- 未指定アドレス(::)  
全てが0のアドレス「::(0:0:0:0:0:0:0:0)」のこと。アドレスがないことを意味する。IPアドレスを自動取得しようとするデバイスが送信するパケットの、送信元アドレスなどに使われる。送信元が未指定アドレスであるパケットはルーティング対象外となる。

- 文章用のIPv6アドレス(2001:db8::/32)  
技術文書やトレーニング資料などのドキュメントの記載に使用される文書用のIPv6アドレスで、「2001:db8::/32」で定義されている。インターネット上で通信できない。

### `インターフェイスID`
IPv6ユニキャストアドレスは、プレフィックス(64ビット)とインターフェイスID(64ビット)で構成される。インターフェイスIDはIPv4のホスト部に相当し、リンク上のインターフェイスの識別に使用される同一サブネットにおいて一意。IPv6では1つの物理インターフェイスに複数のIPv6アドレスを割り当てることが可能(secondaryの指定不要)。手動で設定することが可能。ただし、ホスト数が多くなると手動は困難なため、EUI-64フォーマットを使用して自動生成する仕組みがある。

- EUI-64  
IEEEによって標準化された64ビット長の識別子。ホストが持つMACアドレス(EUI-48)を基にして、一意なインターフェイスIDを生成する。
</br></br>
1.MACアドレスを24ビットずつに分割し、その間に**FFFE**を挿入する。24 + 24 + 16 = 64ビット  
2.U / Lビットと呼ばれる先頭から7番目を反転する  
例:MACアドレス「00-AB-70-12-34-56」の場合  
分割してFFFEを挿入 => 00-AB-70-FF-FE-12-34-56  
U / Lビットを反転 => 02AB:70FF:FE12:3456
</br></br>
EUI-64でインターフェイスIDを自動生成すると、多数のノードに対するIPv6アドレスの割り当て作業を容易にできるが、インターフェイスIDを基にしてMACアドレスを読み取られてしまう。pingやtelnetコマンドも面倒になるため、ルータやサーバなどに対してはインターフェイスIDを手動で設定することを推奨。

### `マルチキャストアドレス（FF00::/8で始める`
インターフェイスのグループを定義するアドレス。マルチキャストアドレスに対して送信されたパケットは、同時にグループの複数の受信者に効率よく伝送できる。IPv6マルチキャストアドレスは先頭8ビットが「1111 1111(FF00::/8)」で始まる。そのあとに4ビットのフラグ(flag)とスコープ(scope)があり、残り112ビットはグループIDとして使用される。  
フラグはマルチキャストのタイプを表す。RFC2373で定義されているフラグは下位ビットのT(*Transient*)フラグのみ。Tフラグが0の場合、そのマルチキャストアドレスはIANAによって永続的に割り当てられたアドレスで、1の場合は一時的なアドレスであることを意味する。上位3ビットは予約で000。スコープはマルチキャストパケットの有効範囲を表す。

|2進数表記   |16進数表記 |スコープ            |
|-----------|---------|-------------------|
|0000       |0        |予約                |
|0001       |1        |インターフェイスローカル|
|0010       |2        |リンクローカル        |
|0011       |3        |予約                |
|0100       |4        |管理ローカル         |
|0101       |5        |サイト(拠点)ローカル  |
|0110, 0111 |6, 7     |未指定              |
|1000       |8        |組織ローカル         |
|1001 ~ 1101|9 ~ D    |未指定              |
|1110       |E        |グローバル           |
|1111       |F        |予約                |

FF02::2の場合:  
FF => マルチキャストアドレス(FFで始まる)  
0 => 永続的(IANAで予約)  
2 => リンクローカル  
2 => 全ルータ  
FF02::1:FF00:0/104 => データリンク層のアドレス解決で使用。残り24ビットはユニキャストアドレスの下位24ビット部分を用いる

|マルチキャストアドレス|説明                        |スコープ             |
|------------------|---------------------------|--------------------|
|FF02::1           |同一リンク上の全ノード         |リンクローカル        |
|FF02::2           |同一リンク上の全ルータ         |リンクローカル        |
|FF02::5           |同一リンク上の全OSRFルータ     |リンクローカル        |
|FF02::6           |同一リンク上の全OSRF指定ルータ  |リンクローカル        |
|FF02::9           |同一リンク上の全RIPngルータ    |リンクローカル        |
|FF01::101         |1台のNTPサーバ上の全NTPプロセス|インターフェイスローカル|
|FF02::101         |同一リンク上の全NTPサーバ     |リンクローカル         |
|FF05::101         |同一拠点内の全NTPサーバ       |サイトローカル         |
|FF08::101         |同一組織(企業)内の全NTPサーバ  |組織ローカル          |
|FF02::1:FF00:0/104|要請ノードマルチキャスト       |リンクローカル        |

### `エニーキャストアドレス(1対多の1と通信)(最も近いノードと通信)`
IPv6で標準実装されたアドレスで、最も近いノードとの通信を可能にする。エニーキャストのアドレス自体はグローバルユニキャストアドレス空間から割り当てる。そのため、エニーキャストアドレス自体はユニキャストアドレスと構造的に区別できない。ユニキャストアドレスが2つ以上のインターフェイスに割り当てられた場合、エニーキャストアドレスに切り替わる。そのアドレスを割り当てられたノードがエニーキャストアドレスであることを認識するように、明示的に設定する必要がある。また、エニーキャストアドレスはパケットの送信元アドレスとして使用することが禁止されている。  
ある送信元ノードがエニーキャストアドレス宛にパケットを送信すると、エニーキャストアドレスが割り当てられたインターフェイス群の中で最も近いインターフェイスに配信される。エニーキャストアドレスを利用すると、インターネット上に設置するサーバの分散配置が可能になり、障害耐性などを向上できる。複数のDNSサーバに同一のグローバルユニキャストアドレスを設定し、そのアドレスをエニーキャストアドレスとして使用すると、ユーザは最寄りのDNSサーバにアクセスできるようになる。

- 予約済みのエニーキャストアドレス  
エニーキャストアドレスには、**サブネットルータエニーキャストアドレス**と呼ばれる予約されたアドレスがある。サブネットルータエニーキャストアドレスは、サブネットに属しているルータ群を識別するために定義された。このアドレスの前半部分はサブネットを識別するプレフィックス(サブネットプレフィックス)、後半部分は全て0になる。あるサブネット上に配置されたルータは、サブネットルータエニーキャストアドレスを認識し、そのサブネットルータエニーキャストアドレス宛にパケットを送信すると、最も近いルータに送信される。

### `IPv6の経路集約`


---
> IPv6のアドレスタイプ:ユニキャスト、マルチキャスト、エニーキャスト  
> ブロードキャスト:廃止  
> エニーキャスト:`最も近いノードと通信`

> EUI-64によるインターフェイスIDの自動生成:  
> MACアドレスの中央に`FFFE`挿入し、U / Lビット(先頭から7ビット目)を反転

> `リンクローカルユニキャストアドレス`:FE80::/10で始まる  
> `マルチキャストアドレス`:FF00::/8で始まる
