# IPv6の主要プロトコル
IPv6通信を表現するには、IPの他にいくつかの重要なプロトコルがある

### `IPCMv6(インターネット制御メッセージプロトコル)`
ICMPv6(*Internet Control Message Protocol for IPv6*)には、ICMPv4版の機能に加えて、マルチキャスト機能やアドレス解決するための機能などが統合されている。RFC4443で定義され、直前にあるヘッダ内のネクストフィールド「58」で識別される。  
ICMPの役割には、エラー通知やネットワーク上の情報収集がある。ネットワークの疎通情報を確認するためのpingはエコー要求とエコー応答のICMPメッセージで実現している。ICMPv6メッセージは、エラーメッセージ(0 ~ 127)と情報メッセージ(128 ~ 255)に分かれる。基本的なものは次の通り。

|タイプ|メッセージ                          |
|-----|----------------------------------|
|1    |*Destination Unreachable*(到達不能)|
|2    |*Packet Too Big*(パケット過大)      |
|3    |*Time Exceeded*(時間超過)          |
|4    |*Parameter Problem*(パラメータ問題) |
|128  |*Echo Request*(エコー要求)          |
|129  |*Echo Request*(エコー要求)          |

### `近隣探索(ND:Neighbor Discovery)`
同一リンク(セグメント)上にあるノードを発見すること。近隣探索プロトコル(**NDP**:*Neighbor Discovery Protocol*)は、MACアドレス解決やルータ検出、アドレス重複などの機能を提供する。また、NDPは同一リンクに接続しているノードへ到達可能かどうか追跡し、リンクローカルアドレスの変化を検出するためにも使用される。近隣探索はRFC4861で定義されており、メッセージがある。

|タイプ|メッセージ                           |
|-----|-----------------------------------|
|133  |RS:*Router Solicitation*(ルータ要請) |
|134  |RA:*Router Advertisement*(ルータ広告)|
|135  |NS:*Neighbor Solicitation*(近隣申請) |
|136  |NA:*Neighbor Advertisement*(近隣通知)|
|137  |Redirect(リダイレクト)                |

- RS / RA  
・アドレス自動設定:DHCPサーバなしにホストにIPv6アドレスを自動的に割り当てる  
・プレフィックス検出:接続されたリンクのプレフィックスを検出し、直接通信可能なアドレス範囲とルータ経由で通信可能な範囲を識別する  
・ネクストホップ決定:パケットの転送先を決定する  
・ルータ検出:ノードが同一リンク上で接続可能なルータを検出する  
・パラメータ検出:リンクMTUやホップリミットの値を検出する

- NS / NA  
アドレス解決:リンク層アドレス(MACアドレス)とIPv6アドレスを関連づける(IPv4のARPに相当)  
重複アドレス検出(DAD):設定したアドレスが他のノードと重複していないか検出する  
近隣ノードの到達不能検出:近隣ノードの通信不能状態を検出する

- Redirect  
リダイレクト:最も効率の良い転送先を通知する(IPv4のICMPリダイレクトに相当)

### `IPv6のアドレス解決`
パケットはレイヤ2ヘッダが付加されてネットワーク上に伝送される。通信相手のIPアドレスに対応するデータリンク層のアドレスが必要になるため、アドレス解決を行う。IPv4の場合ARPをブロードキャストすることでアドレスか解決をしている(イーサネットLANの場合)。IPv6では、近隣探索のNSメッセージをマルチキャストすることでアドレス解決を行う。IPv6インターフェイスにIPv6アドレスが設定されると、そのアドレスのインターフェイスIDに対応する要請ノードマルチキャストアドレスのグループに参加しなければならないと規定されている。NSは**要請ノードマルチキャストアドレス**を宛先にして送信する。  
ホストAからホストCに対してIPv6パケットを送信するとき  
1.ホストA:NSを送信(リンク層アドレスの問い合わせ)、ホストAはIPv6アドレスに対するリンク層アドレスを問い合わせるためのNSを送信  
2.ホストC:NAを送信(NSメッセージに対する応答)、ホストCはNSを受信すると、リンク層アドレスを応答するためのNAを送信する  
3.ホストA:リンク層アドレスをキャッシュに保存:ホストAは取得したリンク層アドレスをキャッシュに保存する

- 要請ノードマルチキャストアドレス


### `重複アドレス(DAD)`


### `自動設定`


- ステートレスアドレス自動設定


- DHCPv6(ステートフルアドレス自動設定)
