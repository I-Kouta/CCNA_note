# IPv6の主要プロトコル
IPv6通信を表現するには、IPの他にいくつかの重要なプロトコルがある

### `IPCMv6(インターネット制御メッセージプロトコル)`
ICMPv6(*Internet Control Message Protocol for IPv6*)には、ICMPv4版の機能に加えて、マルチキャスト機能やアドレス解決するための機能などが統合されている。RFC4443で定義され、直前にあるヘッダ内のネクストフィールド「58」で識別される。  
ICMPの役割には、エラー通知やネットワーク上の情報収集がある。ネットワークの疎通情報を確認するためのpingはエコー要求とエコー応答のICMPメッセージで実現している。ICMPv6メッセージは、エラーメッセージ(0 ~ 127)と情報メッセージ(128 ~ 255)に分かれる。基本的なものは次の通り。

|タイプ|メッセージ                          |
|-----|----------------------------------|
|1    |*Destination Unreachable*(到達不能)|
|2    |*Packet Too Big*(パケット過大)      |
|3    |*Time Exceeded*(時間超過)          |
|4    |*Parameter Problem*(パラメータ問題) |
|128  |*Echo Request*(エコー要求)          |
|129  |*Echo Request*(エコー要求)          |

### `近隣探索(ND:Neighbor Discovery)`
同一リンク(セグメント)上にあるノードを発見すること。近隣探索プロトコル(**NDP**:*Neighbor Discovery Protocol*)は、MACアドレス解決やルータ検出、アドレス重複などの機能を提供する。また、NDPは同一リンクに接続しているノードへ到達可能かどうか追跡し、リンクローカルアドレスの変化を検出するためにも使用される。近隣探索はRFC4861で定義されており、メッセージがある。

|タイプ|メッセージ                           |
|-----|-----------------------------------|
|133  |RS:*Router Solicitation*(ルータ要請) |
|134  |RA:*Router Advertisement*(ルータ広告)|
|135  |NS:*Neighbor Solicitation*(近隣申請) |
|136  |NA:*Neighbor Advertisement*(近隣通知)|
|137  |Redirect(リダイレクト)                |

- RS / RA  
・アドレス自動設定:DHCPサーバなしにホストにIPv6アドレスを自動的に割り当てる  
・プレフィックス検出:接続されたリンクのプレフィックスを検出し、直接通信可能なアドレス範囲とルータ経由で通信可能な範囲を識別する  
・ネクストホップ決定:パケットの転送先を決定する  
・ルータ検出:ノードが同一リンク上で接続可能なルータを検出する  
・パラメータ検出:リンクMTUやホップリミットの値を検出する

- NS / NA  
アドレス解決:リンク層アドレス(MACアドレス)とIPv6アドレスを関連づける(IPv4のARPに相当)  
重複アドレス検出(DAD):設定したアドレスが他のノードと重複していないか検出する  
近隣ノードの到達不能検出:近隣ノードの通信不能状態を検出する

- Redirect  
リダイレクト:最も効率の良い転送先を通知する(IPv4のICMPリダイレクトに相当)

### `IPv6のアドレス解決`
パケットはレイヤ2ヘッダが付加されてネットワーク上に伝送される。通信相手のIPアドレスに対応するデータリンク層のアドレスが必要になるため、アドレス解決を行う。IPv4の場合ARPをブロードキャストすることでアドレスか解決をしている(イーサネットLANの場合)。IPv6では、近隣探索のNSメッセージをマルチキャストすることでアドレス解決を行う。IPv6インターフェイスにIPv6アドレスが設定されると、そのアドレスのインターフェイスIDに対応する要請ノードマルチキャストアドレスのグループに参加しなければならないと規定されている。NSは**要請ノードマルチキャストアドレス**を宛先にして送信する。  
ホストAからホストCに対してIPv6パケットを送信するとき  
1.ホストA:NSを送信(リンク層アドレスの問い合わせ)、ホストAはIPv6アドレスに対するリンク層アドレスを問い合わせるためのNSを送信  
2.ホストC:NAを送信(NSメッセージに対する応答)、ホストCはNSを受信すると、リンク層アドレスを応答するためのNAを送信する  
3.ホストA:リンク層アドレスをキャッシュに保存:ホストAは取得したリンク層アドレスをキャッシュに保存する

- 要請ノードマルチキャストアドレス  
IPv6の要請ノードマルチキャストアドレスは、データリンク層のアドレス解決に使用され、IPv4アドレスのARPに相当する。要請ノードマルチキャストアドレスは「FF02::1:FF00:0 / 104」のプレフィックスと、IPv6ユニキャストアドレスの下位24ビットで構成される。このアドレスのスコープ(有効範囲)はリンクローカル。  
・IPv6ユニキャストアドレス:  
プレフィックス + インターフェイスID + 24ビット  
・要請ノードマルチキャストアドレス:  
FF02:0:0:1:FF + 24ビット
</br></br>
IPv4はARPをブロードキャストで送信していたので、関係のないノードもARPパケットを受信していた。IPv6では通信相手のユニキャストアドレスから要請ノードマルチキャストアドレスを推測することで効率良くリンク層アドレスを解決することができ、アドレス解決の影響を受けるノードはごく少数になる。

### `重複アドレス(DAD)`
リンクローカルアドレスはリンク上で一意である必要がある。EUI-64によってMACアドレスから生成された場合、同一リンク上に同じアドレスが生成される可能性は低いが、手動で設定した場合は重複する可能性がある。IPv6ではノード(インターフェイス)に仮のリンクローカルアドレスが生成されると、同一リンク上ですでに使用されていないかどうか確認するための**重複アドレス検出**(**DAD**:*Duplicate Address Detection*)という処理を実行する。  
DADは、生成した仮リンクローカルアドレスをICMPv6のNSメッセージに挿入して問い合わせる。NSの送信元IPv6アドレスは未指定アドレス(::)、宛先IPv6アドレスは仮リンクローカルアドレスの要請ノードマルチキャストアドレスになる。仮リンクローカルアドレスと同じアドレスが使用されていなければ、NSに対する応答は返ってこない。返信がなければ「アドレスの重複はない」と判断され、仮リンクローカルアドレスは正式アドレスとして実際にし用意可能になる。同じアドレスを使用しているホストが存在した場合、そのホストからNAによって重複アドレスが通知され、一般的には手動による再設定が必要となる。以下手順。  
1:NSを送信(アドレスが使用されていないか照会)、インターフェイスに設定しようとしているアドレスが、同一セグメント上で既に使用されていないか確認するためのNSを送信する  
2:重複アドレスがないことを確認(NSに対する応答なし):リンク上に同じアドレスを使用しているホストが存在しない場合、NSに対する応答はないため、重複しているホストは存在しないと判断される  
3:仮リンクローカルアドレスを正式アドレスとしてインターフェイスに設定する

### `自動設定`


- ステートレスアドレス自動設定


- DHCPv6(ステートフルアドレス自動設定)
