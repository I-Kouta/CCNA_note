# NTPによる時刻同期
NTPはネットワークに接続される機器の時刻情報を同期させるためのプロトコル。ログの解析やサービスの指定時間に動作させたりする際に重要となる

### `NTPによる時刻同期`
**NTP**(*Network Time Protocol*)は、ネットワークに接続される機器の時刻情報を同期させる、UDP上で動作するポート番号123のプロトコル。ネットワーク上の各デバイスが保持する時刻を全て同じにしておくと、収取したログの正確なタイムスタンプを基にしてイベントの関連付けや解析を行うことができる。通常、NTPサーバに接続された原子時計やGPSを情報源にして正確な時刻を取得する。時刻同期は**Stratum**(ストラタム)と呼ばれる階層の概念を使用し、効率よく上位のNTPサーバから多数のデバイスへ時刻情報が配信できるようにしている。Stratumは最上位のNTPサーバを表し、原子時計やGPSから正確な時刻を直接植える。Stratumから時刻を受信したNTPサーバはStratum2になる。1台のデバイスはサーバとクライアントの両方の機能を持っている。NTPサーバは最大で15台まで構築でき、Stratum16とはとは同期できない。インターネット上にはいくつかのStratum1(2)サーバが公開されており、企業内で用意したNTPサーバの時刻は、インターネットで利用可能なパブリックNTPサーバから取得すると良い。

- NTPアソシエーションモード  
NTPを実行しているマシン間の通信のこと。相互に関連づけるためのアソシエーションモードには、下記3つがある。  
Clint / Server:クライアントがサーバに要求を送信して同期を行う一般的なモード  
Symmetric Active / Passive:グループ化された同じ階層のNTPサーバで構成され、相互にバックアップとして機能する  
Broadcast:サーバがブロードキャスト(マルチキャスト)でNTPパケットを送信する。クライアントで特定サーバを指定する必要がなくなり、設定作業が容易になる

- NTPの基本設定  
NTPサーバtアソシエーションを形成し同期を行うには、**ntp server**コマンドを使う。2台以上のNTPサーバを指定することも可能。その場合は、コマンドの最後にpreferオプションを追加すると他のサーバより優先するように指定できる。  
**NTPサーバと時刻同期する(NTPクライアントとして設定)**  
`(config)#ntp server {<ip-address> | <hostname> [prefer]}`  
ip-address:時刻同期を行うNTPサーバのIPアドレスを指定  
hostname:時刻同期を行うNTPサーバのホスト名を指定(名前解決が必要)  
prefer:他のNTPサーバよりも優先(オプション)</br></br>
ルータをNTPサーバとなるように構成するには**ntp master**コマンドを使用する。ストラタム番号は1 ~ 15の範囲で指定可能。外部のNTPサーバよりも大きなストラタム番号を指定すると、外部サーバと同期できなくなったときのみマスターとして動作する。  
**NTPサーバ(マスターロック)として設定**  
`(config)#ntp server [<stratum>]`  
stratum:ストラタム(階層)を1 ~ 15の範囲で指定(オプション)、デフォルトは8

- NTPの検証
