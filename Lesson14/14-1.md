# Ciscoデバイスの管理機能
CDP / LLDPとCisco IOSでのTelnet操作、デバッグ機能について

### `CDP`
**CDP**(*Cisco Discovery Protocol*:シスコデバイス検出プロトコル)は、隣接するシスコデバイスを検出し、プロトコルやアドレス情報などを知ることができるシスコ独自のプロトコル。CDPは**データリンク層で動作**し、ネットワーク層プロトコルに依存しない。そのため、インターフェイスの状態がデータリンク層のレベルでアップしていれば、IPアドレスが割り当てられていない場合でも、CDPの動作には問題ない。CDPメッセージには、SNAPでカプセル化して物理層に渡される。SNAPはイーサネット、トークンリング、フレームリレー、ATMを含むほとんどの物理メディアでサポートされている。
|OSI参照モデル|それぞれのプロトコル                |
|------------|--------------------------------|
|ネットワーク層|IPv4, IPv6など                   |
|データリンク層|CDP                             |
|メディア     |イーサネット, フレームリレー, ATMなど|

- CDPの動作  
CDPはデフォルトで有効で、インターフェイスがデータリンク層レベルで有効になるとCDPメッセージが自動的に送受信される。各シスコデバイスは、自身の情報を含むCDPメッセージを、マルチキャストアドレス「01-00-0C-CC-CC-CC」を使用して60s間隔で送信する。隣接するシスコデバイスによって受信されたCDPメッセージは、180sだけ保持される。受信したCDPメッセージは**他の機器に転送されない**。そのため、CDPは隣接するデバイス感でのみ使用される。他社のスイッチ製品はCDPで検出できない。

- CDPネイバー情報の表示  
CDPによって収集した情報は下記コマンドを使用する。  
`show cdp neighbors`  
`show cdp neighbors detail`または`show cdp entry`  
**show cdp neighbors**コマンドは、隣接デバイスから収集した情報の要約情報表示する。各デバイスを一覧で表示するため、隣接デバイスが多く存在する場合でも容易に確認できる。デバイスの接続情報を確認するときに便利。  
**CDPの要約情報を表示(mode:#, >)**  
`#show cdp neighbors`  
表示される情報:  
Device ID:隣接するデバイスのホスト名  
Local Interface:自身のインターフェイス名  
Holdtime:このCDP情報を保持する残り時間(デフォルトは180s)  
Capability:隣接デバイスがサポートしている機能(Rはルータ、Sはスイッチ)  
Platform:隣接デバイスの製品型番  
Port ID:隣接デバイスのインターフェイス名  
CDPで取得した詳細情報を表示するには**show cdp neighbors**コマンドの後ろにdetailを追加するか、**show cdp entry**コマンドを使用する。詳細情報には、ネットワーク層アドレスやIOSソフトウェアのバージョン情報などが表示される。隣接デバイスのIPアドレスが分かるため、CDPで調べたIPアドレスを使ってpingやTelnet接続を実行したりできる。  
**CDPの詳細情報を表示(mode:#, >)**  
`#show cdp neighbors detail`または`show cdp entry {* | <device-id>}`  
*:全ての隣接デバイスの詳細情報を表示  
device-id:特定のデバイスIDを指定。大文字小文字の区別アリ  
表示される情報:  
Address:隣接デバイスのIPアドレス(ネットワーク層アドレス)  
IOS Software, Version:隣接デバイスのIOSソフトウェアとバージョン

- その他のCDPコマンド  
グローバルで有効なCDPのバージョンおよびCDPメッセージの送信間隔とホールドタイムを確認できる。  
**CDPのグローバルな情報を表示(#, >)**  
`#show cdp`</br></br>
**show cdp interface**コマンドは、CDPが動作しているインターフェイスの状態とカプセル化タイプ、CDPのタイマー状態を表示する。オプションのインターフェイスIDを省略すると、CDPが有効な全てのインターフェイス情報が表示される。CDPが無効なインターフェイスの情報は表示されない。  
**CDPが有効なインターフェイス情報を表示(mode;#, >)**  
`#show cdp interface [<interface-id>]`</br></br>
**show cdp traffic**コマンドは、CDPメッセージを送受信した統計情報やエラーを表示する。特権EXECモードで**clear cdp counters**コマンドでCDPの統計情報をクリアすることができる。  
**CDPメッセージの統計情報を表示(mode:#, >)**  
`#show cdp traffic`

- CDPの無効化  
CDPはデフォルトで有効。CDPメッセージにはホスト名やIPアドレスなどの情報が含まれているため、インターネットに接続しているインターフェイスで送信するとクラッカーに攻撃される危険性がある。直接接続しているのが他社製の機器やPCであればCDPメッセージを送信する必要もない。CDPを停止させるには下記2つがある。  
**CDPをデバイス全体で無効化**  
`(config)#no cdp run`  
**CDPを特定のインターフェイスで無効化**  
`(config-if)#no cdp enable`

- CDPのタイマー変更  
CDPメッセージの送信頻度やホールドタイムの時間を変更するには、下記コマンドを使用する。  
**CDPメッセージの送信頻度の設定**  
`(config)#cdp timer <sec>`  
sec:CDPメッセージの送信頻度を指定。デフォルトは60s  
**CDPのホールドダウンタイムの設定**  
`(config)#cdp holdtime <sec>`  
sec:CDPメッセージを保持する時間を指定。デフォルトは180s

### `LLDP`
CDPで検出できるのは隣接されたCiscoデバイスに限定される。**LLDP**(*Link Layer Discovery Protocol*)は、自身の情報をアドバタイズする近隣探索プロトコルで、IEEE802.ABで標準化されている。CDPと同様にレイヤ2レベルでの接続が確立できれば、異なるベンダの隣接機器の情報を取得できる。LLDPでは**TLV**と呼ばれるタイプ(Type)、長さ(Length)、値(Value)の属性を使用して情報を送受信する。CDP / LLDPはデフォルトで次のTLVをアドバタイズする。LLDPはCDPよりも多くの情報を伝播伝搬することができるのに対し、CDPはより軽量であるという利点がある。  
・DCBXP(*Data Center Bridge Exchange Protocol*) TLV  
・管理アドレス TLV  
・ポート記述 TLV  
・ポートVLAN ID TLV  
・システム機能 TLV  
・システム記述 TLV  
・システム名 TLV

- LLDPの設定  
CDPは全てのCiscoデバイスにおいてデフォルトでは有効だが、LLDPのデフォルト設定はデバイスによって異なる。LLDPは有効化するには下記コマンドを使用する。  
**LLDPをデバイス全体で有効化**  
`(config)#lldp run`  
先頭にnoを付けて実行すると無効化される。外部の脅威から保護するなどの理由から、特定のインターフェイスでLLDPを実行することが望ましくない場合、下記コマンドを使用してLLDP情報を送受信しないようにできる。  
**LLDPを受信しない**  
`(config-if)#no lldp receive`  
**LLDPを送信しない**  
`(config-if)#no lldp transmit`

- LLDPネイバー情報の表示  
LLDPによって収集した情報を表示するには下記コマンドを使用する。  
**LLDPの要約情報を表示(mode:#, >)**  
`#show lldp neighbors`  
**LLDPの詳細情報を表示(mode:#, >)**  
`#show lldp neighbors detail`または`show lldp entry {* | <device-id>}`  
表示される情報:  
Device ID:隣接するLLDPネイバーのホスト名  
Local Intf:自身のインターフェイス名(ポート名)  
Hold-time:このLLDP情報を保持する残り時間(デフォルトは120s)  
Capability:隣接しているデバイスがサポートしている機能(B:Bridge, R:Router)  
Port ID:隣接デバイスのインターフェイス名(ポート番号)

- LLDPのグローバルな情報の確認  
LLDPが有効かどうか、LLDPメッセージの送信間隔とホールドタイムを確認できる。  
**LLDPのグローバルな情報を表示(#, >)**  
`#show lldp`

### `Cisco IOSでのTelnet操作`
CiscoデバイスにリモートからTCP / IPネットワークを経由して管理アクセスするには、TelnetまたはSSHコマンドを実行する。Cisco IOS上で、他のデバイス(Telnetサーバ)にTelnetサーバ接続するには、下記コマンドを使用する。  
**IOSでTelnetサーバに接続する(mode:#, >)**  
`#telnet {<ip-address> | <host>}`  
ip-address:接続先のTelnetサーバのIPアドレスを指定  
host:接続先のTelnetサーバのホスト名を指定(`ip host`コマンドやDNSで名前解決されている必要がある)  
Telnetを実行する前にtelnetコマンド自体を省略することも可能。IPアドレスだけ、またはホスト名だけを入力してEnterキーでTelnetが実行される。Telnet接続を終了するにはexitまたはlogoutコマンドを実行する。

- `ip host`コマンドで名前解決  
pingやtelnetコマンドを実行する際に、デバイスのホスト名を指定することができる。ただし、実際にIP通信を行うにはIPアドレスが必要。そのため、名前とIPアドレスのマッピング情報(データを関連付ける)を事前に用意し、名前を基にIPアドレスを見つける名前解決の処理を行う。一般的にはDNSが使用されるが、Cisco IOSの**ip host**コマンドでコンフィギュレーションファイルに登録しておくと、DNSサーバと接続していない場合でも名前解決できる。  
**IOSによる名前解決**  
`(config)#ip host <host> <address1> [<address2> … <address8>]`  
host:登録するホスト名を指定(hostnameコマンドで設定したホスト名と一致している必要はない)  
address1:IPアドレスを指定  
address2~8:1つの名前に対して最大8つまでIPアドレスをマッピングできる。複数のアドレスをマッピングした場合はpingコマンドでは先頭に指定したIPアドレスのみ使用。telnetコマンドでは先に指定したaddress1から優先的に使用し、アクセスできなければaddress2を使用する。  
名前解決を確認するには**show host**コマンドを使用する。ip hostコマンドとDNSの両方で名前解決された情報を確認できる。  
**名前解決の確認(mode:#, >)**  
`#show hosts`

- 接続状況の確認  
VTY回線の接続状況は**show users**コマンドで確認できる。管理アクセスされているサーバ側で接続中のセッションを一覧表示する。出力結果にはVTYだけでなく、コンソールやAUXなどの回線情報も含まれる。このコマンドで、どのクライアントからTelnetやSSHでリモート接続されているか分かる。  
**現在の接続状況を表示(mode:#, >)**  
`#show users`  
表示される情報:  
・先頭に*が付いている行は、自身がこのデバイスにアクセスしている情報  
・ライン番号。コンソールは0、VTYは機種によって異なる  
・クライアントが接続している回線。「con 0」はコンソール、「vty 0」はVTY回線0を示す  
・Idle:接続してからの経過時間。「00:02:16」であれば2分16秒の経過を示す  
・Location:接続しているクライアントのIPアドレス(名前解決されていればホスト名が表示される)

- Telnetセッションの中断  
Cisco IOSでは、Telnet(SSH)セッションを保持したままの状態で、元のデバイスのCLIに戻ることができる(セッションの中断)。中断したセッションを再開する際には、再びパスワードの入力は必要なく、中断前と同じプロンプトで操作をすぐに再開できるため、管理者は目的のデバイスにすぐアクセスして作業を行える。セッションの中断はCtrl + Shift + 6キーを押し、放した直後にXキーを押す。これでセッションを保持した状態で自身のプロンプトに戻る。中断しているセッション情報の確認には**show session**コマンドを使用する。  
**中断しているセッション情報の表示(mode:#, >)**  
`#show sessions`  
表示される情報:  
・*は直前に接続していたセッションを示す  
・接続ごとに割り当てられるコネクション番号  
・Host:接続先のホスト名(名前解決していないときはIPアドレスが表示)  
・Address:セッションを保持しているデバイスのIPアドレス  
・Idle:アイドル時間(min)

- Telnetセッションの再開  
中断しているTelnet(SSH)セッションを再開するには**resume**コマンドを使用する。resumeの後ろには再開したいセッションのコネクション番号またはホスト名を指定する。コネクション番号は`show sessions`コマンドで確認できる。ただ、直前のセッションについてはEnterキーを押すだけ(`resume`コマンドも不要)で再開できる。また、`resume`コマンドのコネクション番号を省略しても直前のセッションを再開する。  
**直前のセッションの再開(mode:#, >)**  
`#resume`またはEnterキー  
**特定のセッションの再開(mode:#, >)**  
`#resume {<connection-number> | <host>}`  
connection-number:`show session`コマンドで表示されるコネクション番号を指定

- Telnetセッションの終了  
Telnet(SSH)セッションの終了は接続を実行したクライアント自身で終了する方法と接続を受けるサーバ側で終了する方法がある。クライアント自身で終了する際には、リモートデバイス上でセッションを終了する方法とセッションを中断した状態のローカルデバイスから終了する方法がある。  
**クライアント側がリモートデバイスでセッションの終了(mode:#, >)**  
`#exit`または`#logout`  
**クライアント側が中断しているセッションの終了(mode:#, >)**  
`#disconnect [{<connection-number> | <host>}]`  
オプションの指定なしでdisconnectコマンドを実行すると、直前のセッションが終了される。  
**サーバ側でセッションの終了(mode:#)**  
`#clear line <line-number>`  
*は自分自身のセッション接続なので、切断できない  
line-number:`show users`コマンドで表示されるライン(回線)番号を指定

### `Syslog`
ネットワーク機器上のOS、アプリケーション、サービスがシステムの動作状況やメッセージをログとして記録するためのプロトコル(プログラム)。重大なログが発生した場合、即座に管理者へメールで通知することも可能。集めたログは障害解析などに利用され、ログメッセージによって障害を未然に防げることもあり、Syslogは様々なプラットフォーム上で広くサポートされている。Ciscoデバイスも、システムの稼働状況やエラーメッセージなどをログとして出力する。デバイスはSyslogメッセージを生成して、システムエラーやイベントログを次の様々な宛先へ転送されるよう設定できる。リモートサーバへ転送する際にはUDPポート514が使用される。転送先としては端末回線(コンソール、AUXなど)、ロギングバッファ(内部バッファ)、外部装置(外部のSyslogサーバ)がある。

- Syslogメッセージの形式  
Cisco IOSソフトウェアによって生成されるSyslogメッセージは、%で始まる形式で表示される。  
**seq no:timestamp:%facility-severity-MNEMONIC:description**  
seq no:シーケンス番号(オプション)、service sequence-numberコマンドが設定されている場合のみ表示  
timestamp:メッセージまたはイベントの日時(オプション)。service timestamps logコマンドで変更が可能  
facility:メッセージが参照する機能  
severity:メッセージの重大度を示す0 ~ 7のコード  
MNEMONIC:メッセージを一意に示す文字列  
description:レポートされているイベントの詳細を示すテキスト文字列</br></br>
**ファシリティ**はログメッセージの分類を示し、0から23の24種類ある。OSによってファシリティの持つ意味合いが異なり、同じ用途に異なる番号が使用されていることもある。Cisco IOSにはSyslogメッセージを外部装置に送信する場合にはUNIX Syslogファシリティから送信されたSyslogメッセージとして送信する。Syslogサーバへ送信する際のSyslogファシリティは、デフォルトではlocal7になっているが**logging facility**コマンドで変更が可能。  
**Syslogファシリティの変更**  
`(config)#logging facility <facility-type>`  
facility-type:Syslogファシリティのタイプを指定。デフォルトlocal7  
指定可能なfacility-typeキーワードは下記の通り。

|キーワード|説明                    |
|--------|------------------------|
|auth    |許可システム              |
|cron    |cronファシリティ          |
|daemon  |システムデーモン           |
|kern    |カーネル                  |
|local0-7|ローカルに定義されたメッセージ|
|lpr     |ラインプリンタシステム       |
|mail    |メールシステム              |
|news    |USENETニュース             |
|sys9-14 |システムで使用              |
|syslog  |システムログ                |
|user    |ユーザプロセス               |
|uucp    |UNIXからUNIXへのコピーシステム|

重大度は**シビリティ**(severity)は0から7の数値で定義され、値が小さいほど重大度が高く、それぞれに対応した名前が定められている。
|severity|名前               |説明                                     |
|--------|------------------|----------------------------------------|
|0       |Emergencies(緊急)  |システムが利用できなくなる緊急な状態          |
|1       |Alerts(アラート)    |システムを安定させるための迅速な対応が必要な状態|
|2       |Critical(重要)     |注意すべき危険な状態                        |
|3       |Errors(エラー)     |問題を究明できるエラー状態                   |
|4       |Warnings(警告)     |重大な問題ではないが注意すべき状態            |
|5       |Notifications(通知)|正常だが注意すべき状態                      |
|6       |Informational(情報)|状態通知メッセージ                          |
|7       |Debugging(デバッグ) |トラブルシュート用のデバッグメッセージ         |

デフォルトではコンソールへのログ表示は有効化されている。コンソールへのログメッセージ表示を無効化するには**no logging console**コマンドを使用する。  
**コンソールへのログ表示の無効化**  
`(config)#no logging console`  
無効化されたログの表示を再度有効にするには、**logging console**コマンドを実行する。出力するログのレベルを指定することも可能。オプションでレベルを指定すると、そのレベル以上のメッセージが表示される。  
**コンソールへのログ表示のレベル指定**  
`(config)#logging console [<level>]`  
level:ログのレベルを0から7の範囲で指定。指定したレベル以上のメッセージのみ表示する。デフォルトは7以上

- Syslogサーバの設定  
ログメッセージをSyslogサーバへ送信するには**logging**コマンドを使用してSyslogサーバのIPアドレスまたはホスト名を指定する必要がある。  
**Syslogサーバの指定**  
`(config)#logging {<ip-address> | <hostname>}`  
また、**logging trap**コマンドでSyslogサーバに送信されるシビリティレベルを制限することも可能。指定したseverity以下のSyslogメッセージが送信される。  
**Syslogメッセージのseverityの指定**  
`(config)#logging trap <severity>`  
severity:severity値(0から7)またはseverity名を指定

- ロギングバッファの設定  
生成されたログメッセージをロギングバッファ(内部バッファ)に保存したい場合は**logging buffered**コマンドを使用する。オプションでバッファ容量や保存するメッセージのレベル(severity)を指定できる。  
**ロギングバッファの設定**  
`(config)#logging buffered [<size>] [<severity>]`  
size:バッファ容量の4096 ~ 2147483647の範囲で指定(オプション)、デフォルトは4096バイト  
severity:severity値(0 ~ 7)またはseverity名を指定(オプション)  
内部バッファに保存されたログメッセージは**show logging**コマンドで確認できる。Syslogサーバの設定情報も表示される。  
**内部バッファの表示(mode:#)**  
`#show logging`

### `VTY(仮装端末)回線へのログ表示`
デフォルトでは、VTY回線へのログ表示は無効化されている。TelnetやSSHによってVTYへリモート接続しているときにログメッセージを表示するには**terminal monitor**コマンドを実行する。これでTelnetやSSHのセッションにログメッセージとデバッグの両方が出力される。デフォルトの状態に戻すには**terminal no monitor**コマンドを実行する。ログアウトした場合にはログ表示は無効になる。  
**VTY回線へのログ表示(mode:#)**  
`#terminal monitor`

### `デバッグ機能`
ルータやスイッチのあるプロセスに関する動作をリアルタイムにモニタリングするための機能。デバッグを有効にすると、デバイス内部で行われる各種プロセスの動作をターミナルソフトウェア上でリアルタイムに確認でき、特定のプロセスやプロトコルが正しく動作しているか判断できるため、トラブルシューティングや動作検証で役立つ。

- デバッグの実行  
デバッグを有効化するには**debug**コマンドを実行する。  
`#debug <options>`  
options:モニタリング対象のプロセスやイベント名を指定  
debugコマンドに続けて指定可能なオプションは様々なものがある。デバッグ機能はデバイスに負荷がかかるため、必要なものだけを有効化する。「`debug ?`」(使用できるコマンドを表示？)や「`debug cdp packets`(CDPメッセージの送受信の動作のモニタリング)」をできる。

- デバッグの停止

- デバッグおよびログのタイムスタンプ設定

- CPU利用室の確認

### `システムロックの設定`

- システムロックの主導設定

- タイムゾーンの設定

---
> CDPはレイヤ2プロトコル。ケーブルを接続してインターフェイスを有効化(no shutdown)すると使用できる。IPアドレスの設定なしでも可

> `show cdp neighbors`:ポート情報を確認する  
> `show cdp neighbors detail`, `show cdp entry`:IPアドレスを知りたい

> |                     |CDP              |LLDP                   |
> |---------------------|-----------------|-----------------------|
> |標準                  |シスコ独自        |IEEE802.1AB            |
> |動作レイヤ             |データリンク層(L2) |データリンク層(L2)       |
> |アドバタイズ           |マルチキャスト     |マルチキャスト            |
> |マルチキャストMACアドレス|0100.0CCC.CCCC  |0180.C200.000E          |
> |利点                  |軽量             |高度にカスタマイズ可能(TLV)|

> Telnetを中断したときのIOS操作  
> クライアント側:`show sessions`, `resume`, `disconnect`  
> サーバ側のコマンド:`show users`, `clear line`
>
> `show sessions`(クライアント側) - Telnetを再開する時  
> 直前のセッション => Enterキーを押す  
> 特定のセッション => `resume <コネクション番号>`  
> `show sessions(クライアント側)` - セッションを中断するとき  
> 直前のセッション => `disconnect`  
> 特定のセッション => `disconnect <コネクション番号>`
>
> `show sessions`(サーバ側)  
> 特定のセッションを切断 => `clear line <ライン(回線)番号>`
