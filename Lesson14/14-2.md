b# Ciscoルータの管理
Ciscoルータは特定の順序で一連の手順を実行する。Ciscoルータのトラブルシューティングを行う際には、ブートシーケンスの知識が役立つ。

### `ルータの内部コンポーネント`
Ciscoルータの主要な内部コンポーネントには、CPU、インターフェイス、メモリがある。

- CPU  
ルーティング機能やシステムの初期化など、オペレーティングシステムの指示を実行する。

- インターフェイス  
ルータを外部と物理的に接続する。USBによって、ルータ構成(設定情報)とCisco IOSソフトウェアイメージの保存と配置ができる。  
・イーサネット、ファストイーサネット、ギガビットイーサネット  
・同期 / 非同期シリアル  
・コンソールポートおよび補助(AUX)ポート  
・USBポート

- メモリ  
メモリにはサイズや特性の違いにより、いくつか種類がある。Ciscoルータには4種類のメモリが内蔵されている。  
・ROM  
・フラッシュメモリ  
・NVRAM  
・RAM

### `メモリの種類`
Ciscoルータには、次の4種類のメモリが内蔵されている。
|メモリ        |格納されているもの                                           |
|-------------|----------------------------------------------------------|
|ROM          |POST、ブートストラップ、ROMモニタ、Mini IOS                    |
|フラッシュメモリ|IOSソフトウェアイメージ                                      |
|NVRAM        |コンフィギュレーションレジスタ、startup-config(手動で保存した場合)|
|RAM          |running-config、IOS、ルーティングテーブル、ARPテーブルなど      |

- ROM  
**ROM**(*Read Only Memory*)は読み取り専用のメモリで、ルータを起動するためのマイクロコード数や、パスワードのリカバリなど、障害復旧を行うためのプログラムが格納されている。ブートストラップはデフォルトではフラッシュメモリを検索してロードする。

|プログラム             |説明                                                                                 |
|---------------------|------------------------------------------------------------------------------------|
|POST                 |電源投入時にCPUや各種メモリ、インターフェイスなどのハードウェア検査を実施するための自己診断プログラム|
|ブートストラップ        |IOSをロードする。コンフィギュレーションレジスタ値に基づいてIOSを検索してロードする               |
|ROMモニタ(ROMMON)     |パスワードリカバリやIOSダウンロードなど、トラブルシューティングの際に使用する                    |
|Mini IOS(ブートヘルパー)|IOSの一部の機能だけを実装したプログラム。レガシーな機能でサポートしており現在は格納されていない    |

- フラッシュメモリ  
自由に読み書き可能なメモリで、ルータの電源を切っても内容は消えない。フラッシュメモリには、主にIOSソフトウェアイメージが格納されている。IOSソフトウェアは圧縮されているため、ルータ起動時にブートストラップによってRAM上に展開して読み込まれることになる。フラッシュメモリの内容確認をするには**show flash**メモリを使う。フラッシュメモリに格納されている**ファイル名やサイズ、メモリの空き容量など**が表示される。  
**フラッシュメモリの表示(mode:#, >)**  
`#show flash:`

- NVRAM  
不揮発性ランダムアクセスメモリと呼ばれる(*Non-Volatile Random Access Memory*)。電源を切っても内容が消えない。管理者はNVRAM内のルータの起動時に使用される設定情報を**startup-config**という名前のコンフィギュレーションファイルとして格納されている。NVRAMには、コンフィギュレーションレジスタも格納されている。コンフィギュレーションレジスタ値は、**show version**コマンドで確認できる。

- RAM  
読み書き可能だが、ルータの電源を切ると記録した内容が消えてしまうメモリ(*Random Access Memory*)。ルータが起動しているときの作業領域として使用され、稼働中のコンフィギュレーションファイル(**running-config**)、IOS、ルーティングテーブル、ARPテーブルなどが保持される。

### `ルータの起動シーケンス`
ルータの電源投入(ブート時)に発生するイベントのシーケンスを知ることは不具合が発生した際のトラブルシューティングに役立つ。Ciscoルータの電源を投入したときに実行されるイベントの順序は以下の通り。  
1.POSTの実行  
**POST**(*Power-On Self-Test*:電源投入時自己診断テスト)が起動し、ルータの全てのコンポーネント(CPU、インターフェイス、メモリ)が機能するかどうかを確認する。テスト中にルータに存在するハードウェアを特定する作業も行う。</br></br>
2.ブートストラップのロードと実行  
**ブートストラップコード**は、Cisco IOSソフトウェアの検出、RAMへのロード、Cisco IOSソフトウェアの実行などのイベントを実行する。ブートストラップコードは実行されるCisco IOSソフトウェアを特定するために、NVRAM内のコンフィギュレーションレジスタのブートフィールド値をチェックする。ブートストラップは、ルータの起動時にのみ使用される。</br></br>
3.Cisco IOSソフトウェアのロード  
ブートストラップコードが適切なIOSイメージを検出すると、それをRAMに読み込んでロードする。Ciscoルータのほとんどの機種ではIOSは圧縮されており、RAM上に展開して起動する。</br></br>
4.コンフィギュレーションファイルの検出  
NVRAMに保存済みのコンフィギュレーションファイル(startup-config)が存在する場合、それをRAMに読み込んでrunning-configとして実行する。一方、NVRAMにstartup-configが存在しない場合、セットアップモードを起動する。</br></br>
5.Cisco IOSソフトウェアの実行  
running-configを使用してCisco IOSソフトウェアを実行し、プロンプトが表示される。

### `コンフィギュレーションレジスタ`
ルータの動作を制御する16ビットの値。各ビットの値によって、次回の再起動または電源投入時のルータ動作に影響を与える。コンフィギュレーションレジスタを使用して、下記のことができる。  
パスワードリカバリ(パスワード復旧)  
ROMモニタで強制的にブートする  
ブート元おとびデフォルトのブートファイル名を選択する  
ブロードキャストアドレスを制御する  
コンソールの回線速度を変更する  
コンフィギュレーションレジスタはNVRAMに保存されており、現在の値は**show version**コマンドで確認できる。出力の最終行に表示されている16進数4桁の値がルータのコンフィギュレーションレジスタで、0x2102はデフォルト値。各ビットには以下のような意味がある。  
0 ~ 3:ブートフィールド。この値によって、ルータがIOSをロードするかどうか、どのようにしてIOSイメージをロードするか決める  
6:NVRAMの設定(startup-config)を制御する。1にすると起動時にstartup-configを無視し、0にすると読み込む(0がデフォルト)  
7:OEM(*Original Equipment Manufacturer*)ビットをイネーブルにする  
8:コンソールのBreakキーによるブレーク信号を制御する。ただし、ルータの電源を投入してから60minは設定に関係なくブレーク信号を受け付ける。1にすると、コンソールのブレークキーを無視(デフォルト)、0にすると強制的にROMモニタモード(ROMMON)にする  
9:システムブートを制御する、通常は変更しない。1にするとセカンダリブートストラップを使用し、0にするとフラッシュメモリから起動する(デフォルト)  
10:ブロードキャストアドレスのホスト部のビットを全て1(0)に決定する。ビット14と連動して動作する。1だとプロセッサは全て0を使用し、0だとプロセッサは全て1を使用する(デフォルト)  
5, 11, 12:コンソールの回線速度(ポーレート)を制御する。デフォルトの回線速度は9600ボー(値)で、この場合は5, 11, 12が全て0である。CLIのspeedコマンドを使って変更が可能  
13:ネットワークブートの失敗時の対応を指示する。1にするとネットワークブート失敗時にデフォルトのROMソフトウェア(通常はこれ)を起動する(デフォルト)、0にすると無限にネットワークブートを試みる  
14:ブロードキャストアドレスのネットワーク(サブネット部を含む)部のビットを全て1または0に決定する。ビット10と連動して動作する。1にするとプロセッサは全て0を使用し、0にするとプロセッサは全て1を使用する(デフォルト)  
15:1にすると、診断メッセージを表示してNVRAMのstartup-configを無視する(デフォルトは0)

- ブートフィールド  
コンフィギュレーションレジスタの下位4ビット(ビット番号0 ~ 3)のこと。ブートフィールドは、ルータがCisco IOSソフトウェアを特定する方法を制御する。

|ブートフィールド値   |意味                                                                                       |
|------------------|------------------------------------------------------------------------------------------|
|0000(0x0)         |ROMモニタ(ROMMON)で起動する                                                                  |
|0001(0x1)         |ROM内のブートヘルパーイメージ(Mini IOS)で起動する。無ければフラッシュメモリのIOSをRAMに読み込む        |
|0010~1111(0x2~0xF)|NVRAM内のstartup-configのboot systemコマンドで指定された通りIOSを起動する。コマンドによる指定が無ければフラッシュメモリのIOSをRAMに読み込む(デフォルト)|

デフォルトのコンフィギュレーションレジスタ値は「0x2102」で、ブートフィールドの値は「0010(0x2)」。ルータの起動時にNVRAMのstartup-configにboot systemコマンドがあればそれに従い、無ければフラッシュで検出された最初のCisco IOSイメージで起動する。  
例:0x2102の場合:0010.0001.0000.0010  
2進数4ビットずつで区切って表す。0 ~ 3は1、4 ~ 7は該当ナシ、8 ~ 11は8、12 ~ 15は13。1, 8, 13が該当する。

- パスワードリカバリでのコンフィギュレーションレジスタ値

- コンフィギュレーションレジスタ値の変更

### `Cisco IOSソフトウェアの検索順序`

---
> ルータの起動順序  
> **POST実行 => IOS検索 => IOSロード => 設定ファイルの検索 => 設定のロード**
