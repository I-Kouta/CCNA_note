# インターネット層
パケットの電装経路や送信元や宛先の特定にかかわるアドレッシング方法(CPUが命令を実行する際に対象データの所在地を指定する方法)などを定義し、異なるネットワーク上にあるノード間の通信を実現する。インターネット層の中心となるプロトコルのIPのほかに、ARPやICMPなどがある。

### `IP`
IP(*Internet Protocol*)は、インターネット層で中心的な役割を果たすプロトコル。IPv4とIPv6の2種類がある。
- コネクションレス型プロトコル:返信側と受信側の間で通信できるかどうかを確認しないコネクションレス型プロトコル。データが正しく届いたかどうかの確認などの制御は行わない。
- ベストエフォート型の配信:「パケット配送の保証はしないが最善の努力はする(**保証なし**)」。信頼性を高めた通信が必要な場合、TCPなどの信頼性の機能を提供する上位層プロトコルに任せる。
- データ回復機能なし:IP自体には廃棄されたパケットの再送信を要求するエラー回復機能はない。必要であれば上位層で対応する。
- 階層型アドレッシング:IPは階層構造のアドレス体系をもつ。IPアドレスの上位の桁はネットワークを識別し、下位の桁はそのネットワークに接続されたノードを識別する。

### `IPv4ヘッダ`
- バージョン(4ビット):IPプロトコルのバージョン番号。IPv4では4が入る
- ヘッダ長(4ビット):IPヘッダの長さ。32ビット単位で表し、オプションフィールドがなければ5が入る
- サービスタイプ(8ビット):TOSフィールドとも呼ばれ、IPパケットの優先制御(Qos.(*Quality of Service*。パケットの優先度に応じて扱いを区別し輻輳や遅延から守る))を行う
- 最大長(16ビット):パケット全体(IPヘッダ + データ)の長さをオクテット単位で表す
- 識別子(16ビット):転送するデータがリンクで許容されるMTU(*Maximum Transmission Unit*。一度に転送できるデータの最大値)を超え、フラグメンテーション(断片化。連続しているデータを小さな不連続のブロックに分断する)によって複数のパケットに分割されたパケットに割り当てられる識別子。分割された複数パケットの識別子には同じID番号が割り当てられ、復元に使用される
- フラグ(3ビット):パケットのフラグメント処理を禁止するするなどのフラグメンテーション制御に使用される。第1ビットは未使用のため0、第2ビットではフラグメント処理を許可するか禁止するか指定。第3ビットはフラグメント処理されている場合に、そのフラグメントが途中のパケットか最後なのかを表す
- フラグメントオフセット(13ビット):フラグメント処理されている場合に、元のデータのどの位置にあったデータかを示す位置情報
- 生存時間(8ビット):一般的には単にTTL(*Time To Live*)と呼ばれ、パケットの生存時間を示すが、実際には時間ではなく「パケットが通過できるルータの数」が入る。ルータはパケットを中継するたびにTTL値を1ずつ減らし、0になるとパケットを破棄することによって、パケットがネットワーク上で永遠に転送され続ける問題を回避する。8ビットであるため、0~255の範囲が入る
- プロトコル(8ビット):上位プロトコルを識別するための番号。受信側では、プロトコルフィールドを参照することによって、どの上位プロトコルにデータを渡せばよいかを判断する。IANAが管理しており、ICMPは1、TCPは6、UDPは17など。
- ヘッダチェックサム(16ビット):IPヘッダのエラーチェックを行う(データ部分のチェックはTCPなどの上位層に任せる)
- 送信元アドレス(32ビット):パケットの送信元IPアドレス
- 宛先アドレス(32ビット):パケットの宛先IPアドレス
- オプション(可変長):通常は使用されず、テストやデバッグなどの処理時のみ使用される
- パディング(可変長):オプションの使用時に、IPヘッダが32ビットの倍数になるよう調整するために0が挿入される  
合計20バイト。オプションを使用する場合、最大60バイト。

### `ARP`
ARP(*Address Resolution Protocol*)は、IPアドレスからMACアドレスを取得するためのプロトコル。TCP / IPの通信では、宛先IPアドレスを基にパケットを送信するが、イーサネットLANで通信を行うには物理的なアドレスである宛先MACのアドレスも必要になる。通常、送信元である自身のIPアドレスとMACアドレスは認識しているが、宛先のMACアドレスは不明。このとき、IPアドレスからMACアドレスを自動的に調べるための仕組としてARPを使用する。
- ARPの動作:宛先IPアドレスを含むARPリクエスト(要求)を**ブロードキャスト**し、受信したホストはARPリクエストの内容が自分のIPアドレスと同じであればARPリプライに自身のMACアドレスを入れて送信(返信)する。ARPによって取得した情報は、ARPテーブルにしばらく保持される。ARPテーブルにキャッシュすることによって頻繁に同じ相手と通信する場合、その都度ARPでアドレス解決する(ブロードキャストされる)ことを防ぐ。キャッシュされた情報は、一定の時間だけ使われなければ消去される。ARPキャッシュが消去される時間はOSなどによって異なる。次の手順で宛先のMACアドレスを取得する。
1. ARPテーブル参照
2. ARPリクエスト(要求)送信
3. ARPリプライ(応答)送信
4. ARPテーブル更新

以下、ホストAがホストDと通信する場合(間にホストBとCがある)。
1. ARPテーブル参照:ホストAがD宛にデータ送信を実行すると、アプリケーション層プロトコルに渡され、各層のプロトコルで処理が行われる。レイヤ2では上位層から渡されたパケットをフレームにカプセル化(ネットワーク層->リンク層)するため、宛先IPアドレスに対応するMACアドレスを調べる。ホストAはARPテーブルを参照し、宛先DのMACアドレスが学習されているか確認(されていないとする)。
2. ARPリクエスト(要求)送信:ホストAはARPリクエスト(要求)を生成し、全員宛のブロードキャスト(宛先MACアドレス:FF-FF-FF-FF-FF-FF)で送信する。
3. ARPリプライ(応答)送信:全ホストはARPリクエストを受信し、パケットの内容を確認する。ホストDは自身のIPアドレスと一致するため、自分に対するARP要求と判断し、他のホストはIPアドレスが異なるため関係ないと判断してARPメッセージを破棄する。ホストDはARPリプライ(応答)を生成し、ホストAからのARPに**ユニキャスト**で応答する。ホストDは自身のARPテーブルにARPリクエストの送信元であるホストAのIPアドレスとMACアドレスを登録する。
4. ARPテーブル更新:ホストAはARPリプライを受信し、取得したホストDのMACアドレスとIPアドレスをARPテーブルに登録し、バッファに保留していたD宛のパケットをイーサネットフレームにカプセル化してネットワーク上に送信する。ホストAからDへ返信されるデータのレイヤ2とレイヤ3のヘッダには以下のアドレスが含まれる。

|            |レイヤ2(イーサネットヘッダ)|レイヤ3(IPヘッダ) |
|------------|-----------------------|----------------|
|送信元アドレス|ホストAのMACアドレス      |ホストAのIPアドレス|
|宛先アドレス  |ホストDのMACアドレス      |ホストDのIPアドレス|

- 別ネットワークの相手と通信する場合のARP
ARPリクエストはブロードキャストで送信されるが、ルータはブロードキャストを他のネットワークへ転送しないため、ルータの先にある別ネットワークの宛先ホストのMACアドレスを取得できない。通信相手が別のネットワークにいる場合、パケットはデフォルトゲートウェイであるルータに渡して転送してもらう必要がある。通信相手が異なるブロードキャストドメインの場合、ホストAはデフォルトゲートウェイ(ルータE0)のMACアドレスをARPで取得し、アドレス解決(プロトコル上のアドレスを物理的なアドレスに置き換える)したあとにパケットをデフォルトゲートウェイに渡す。ルータもホストDのMACアドレスをARPで取得したあとにパケットを宛先Dに転送する。  
ホストAがデフォルトゲートウェイに送信:レイヤ2の宛先アドレスにルータのE0のMACアドレスを含み、ARPで取得  
ルータがホストDに転送:レイヤ2の宛先アドレスにホストDのMACアドレスを含み、ARPで取得  
送信元と宛先のレイヤ3アドレスは、通信の途中にどのネットワークを介しても変更されることはない。ただ、レイヤ2アドレス、ルータを経由する前後で送信元と宛先のアドレスが変化する。
- ARPテーブルの表示
Windows PCでARPテーブルに保存されたキャッシュを表示する場合、`arp -a`コマンドを使用する。キャッシュエントリを即時に消去するには`arp -p`コマンドを実行する。また、CiscoルータでARPテーブルを表示する場合、`show ip arp`(またはshow arp)コマンドを使用する。

### `ICMP`
- エラー通知(Error)
- 問い合わせ(Query)
- ping
- traceroute

> ### ルータはパケットを転送する際にフレームヘッダのレイヤ2のアドレスとFCSを書き換える。レイヤ3のアドレスは変更されない。スイッチはフレームを転送する際にアドレスを書き換えることはない

> ### ARPまとめ
> ### `・IPアドレスを基にMACアドレスを取得する`
> ### `・インターネット層のプロトコル(リンク層にもまたがる)`
> ### `・ARPパケットにIPヘッダが含まれない`
> ### `・ARPリクエストはブロードキャストで送信する`
> ### `・ホストはフレームの宛先MACアドレスを決定するためにARPを使用`
> ### `・転送途中のルータもネクストホップのMACアドレスを主t苦するために、ARPを実行する`
> ### `・windowsの場合は「arp -a」、Cisco IOSは「show ip arp」でARPテーブルの表示`
