# トランスポート層
アプリケーションに対して信頼性のある通信を提供する役割がある。送信したデータが宛先に正しく届けられることが保証されている通信を実現する必要がある。

### `トランスポート層の機能`
**TCP**(*Transmission Control Protocol*)と**UDP**(*User Datagram Protocol*)の2つのプロトコルがあり、これによってアプリケーションに直接通信サービスを提供する。トランスポート層が提供する基本サービスに**セッションの多重化**があり、1つのIPアドレスを持つコンピュータで複数のアプリケーションを同時に使用できるようになる。TCPとUDPの両方でサポートされている。  
TCPはコネクション型のプロトコルのエンドツーエンド間で信頼性の高い通信を行う。UDPはコネクションレス型で、データ転送サービスのみを提供する単純なプロトコル。どちらを使用するかは、アプリケーション層プロトコルによって決定される。

### `ポート番号`
コンピュータがデータ通信を行う際に通信先のアプリケーションを特定するための番号。TCP / IP通信ではIPアドレスで通信相手を特定できるが、動作している複数のアプリケーションの識別はできない。データを届けるまでがIPの役割で、アプリケーションにデータを届けるのがポート番号の役割。ポート番号によって1台のコンピュータで複数のアプリケーションを同時に使用できる。それぞれのプログラムをポート番号で識別し、正しくデータを渡すように処理している。16ビットの整数で、0 ~ 65535の範囲。IANAによって次の3種類に分かれる。

|ポート番号     |種類            |説明                                            |
|-------------|---------------|------------------------------------------------|
|0 ~ 1023     |ウェルノウンポート|プロトコル別に予約されサーバで使用される番号            |
|1024 ~ 49151 |登録済みポート   |番号とアプリの関係を登録できる。1024番までは予約されている|
|49152 ~ 65535|ダイナミックポート|自由に使用でき、クライアントが送信元ポートとして使う     |

*well-known*は一般的に使用されるアプリケーションごとに割り当てられている。Webサーバにアクセスしてユーザ側(クライアント)では80番(HTTP)を宛先ポートとしてアクセスし、Webサーバ側では80番のポートを開いて接続を待つ。アプリケーション毎に予めポート番号が決められているためクライアントはその番号を宛先に指定することで特定のアプリケーションにアクセスすることができる。サーバからのデータを適切なアプリケーションで受け取るためには、ユーザ側にもポート番号が必要になる。ユーザ側で使用するポート番号は通常アプリケーション同士で重複しないようにOSがランダムに割り当てる。

|ポート|プロトコル   |TCP / UDP|
|-----|-----------|----------|
|20   |FTP-Data   |TCP       |
|21   |FTP        |TCP       |
|22   |SSH        |TCP       |
|23   |Telnet     |TCP       |
|25   |SMTP       |TCP       |
|53   |DNS        |UDP, TCP  |
|67   |DHCP       |UDP       |
|68   |DHCP       |UDP       |
|69   |TFTP       |UDP       |
|80   |HTTP       |TCP       |
|110  |POP3       |TCP       |
|123  |NTP        |UDP       |
|161  |SNMP       |UDP       |
|162  |SNMP(TRAPS)|UDP       |
|443  |HTTPS      |TCP       |
|520  |RIP        |UDP       |

※67 - *Bootstrap Protocol Server*  
※68 - *Bootstrap Protocol Client*

### `TCP`
**TCP**(*Transmission Control Protocol*)は、コネクション型プロトコル。データ送信の前に通信相手とのコネクションを確立する。アプリケーション層からデータを受け取り、ネットワーク層のMTUに適したサイズに分割しTCPセグメントを生成する(**セグメンテーション**)。  
・送信元ポート(16ビット):送信元のポート番号  
・宛先ポート(16ビット):宛先のポート番号  
・シーケンス番号(32ビット):分割されたデータのどのデータ部かを示す番号。受信側で到着したデータの順序制御に使用される  
・確認応答番号(32ビット):データを受信したことを感知し、次に受信したいデータのシーケンス番号を通知する  
・データオフセット(4ビット):TCPヘッダは可変長のため、受信側はこの値によってTCPヘッダの末尾を認識し、データ部分の位置を判断する  
・予約(6ビット):将来の拡張に備えて予約している未使用のフィールド、通常0  
・制御ビット(6ビット):6つのビットで構成され、個々のビットに意味をもたせて様々な制御を行う。各ビットはフラグと呼ぶ  
・ウィンドウ(16ビット):受信側で受信可能なバッファの大きさを受信側に通知するために使用される。単位はオクテット  
・チェックサム(16ビット):TCPヘッダとデータ部のエラーチェックを行う  
・緊急ポインタ(16ビット):緊急処理が必要なデータの場所を示す値。URGビットは1にセットされる  
・オプション(可変長):必要に応じてオプション追加  
・パディング(可変長):オプションを使用した時、TCPヘッダが32ビットの倍数になるように0を挿入して調整する  

|フラグ                |1がセットされたときの意味                                                                |
|---------------------|-------------------------------------------------------------------------------------|
|URG(*Urgent Pointer*)|緊急に処理すべきデータを含んでいる、緊急ポインタフィールドと一緒に使用                           |
|ACK(*Acknowledgment*)|確認応答番号フィールドが有効であることを示す。最初にコネクションを確立するするSYNセグメント以外は常に1|
|PSH(*Push*)          |受信したデータをすぐにアプリケーションを渡す                                                 |
|RST(*Reset*)         |何らかの異常が検出されたため、コネクションの強制切断を要求                                      |
|SYN(*Synchronize*)   |コネクションの確立を要求                                                                  |
|Fin(*Finish*)        |これ以上送信データがないためコネクションの終了を要求                                           |

- コネクションの確立と終了  
アプリケーションのデータ送信を行う前に仮想のコネクションを確立してからデータのやり取りを開始する(**スリーハンドウェイシェイク**)。制御ビットを使用してTCPセグメント3回やり取りし、この時に**シーケンス番号の初期値を設定**する。

1.ホストAからBにコネクション確立を要求(SYNセグメント)  
制御ビット(SYN = 1, ACK = 0)  
初期シーケンス番号:ランダムな値(ex.100)  
確認応答番号:0
2.Aからのコネクションの確立の要求に応え、ホストBからAに対してもコネクション確立を要求する(ACK・SYNセグメント)  
制御ビット(SYN = 1, ACK = 1)  
初期シーケンス番号:ランダムな値(ex.300)  
確認応答番号:受信した時のシーケンス番号 + 1
3.ホストAはからのコネクション確立の要求に応える(ACKセグメント)  
制御ビット(SYN = 0, ACK = 1)  
初期シーケンス番号:初期値 + 1(101)  
確認応答番号:受信した時のシーケンス番号 + 1

このあと実際のデータ転送が開始される。データの転送時に使用されるシーケンス番号はそのまま引き継がれる。データの送信が完了した時には、制御ビットのFINフラグによって相手に終了の要求を通知する。

- 順序制御と確認応答

- 再送制御

- ウィンドウ制御(フロー制御)

### `UDP`
- UDPの用途

---
> `TCP:コネクション型、信頼性あり / 同期された通信`  
> `UDP:コネクションレス型、信頼性なし`

> TCP通信では`最初に3ハンドウェイシェイクを行ってコネクションを確立する`
