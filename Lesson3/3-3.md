# トランスポート層
アプリケーションに対して信頼性のある通信を提供する役割がある。送信したデータが宛先に正しく届けられることが保証されている通信を実現する必要がある。

### `トランスポート層の機能`
**TCP**(*Transmission Control Protocol*)と**UDP**(*User Datagram Protocol*)の2つのプロトコルがあり、これによってアプリケーションに直接通信サービスを提供する。トランスポート層が提供する基本サービスに**セッションの多重化**があり、1つのIPアドレスを持つコンピュータで複数のアプリケーションを同時に使用できるようになる。TCPとUDPの両方でサポートされている。  
TCPはコネクション型のプロトコルのエンドツーエンド間で信頼性の高い通信を行う。UDPはコネクションレス型で、データ転送サービスのみを提供する単純なプロトコル。どちらを使用するかは、アプリケーション層プロトコルによって決定される。

### `ポート番号`
コンピュータがデータ通信を行う際に通信先のアプリケーションを特定するための番号。TCP / IP通信ではIPアドレスで通信相手を特定できるが、動作している複数のアプリケーションの識別はできない。データを届けるまでがIPの役割で、アプリケーションにデータを届けるのがポート番号の役割。ポート番号によって1台のコンピュータで複数のアプリケーションを同時に使用できる。それぞれのプログラムをポート番号で識別し、正しくデータを渡すように処理している。16ビットの整数で、0 ~ 65535の範囲。IANAによって次の3種類に分かれる。

|ポート番号     |種類            |説明                                            |
|-------------|---------------|------------------------------------------------|
|0 ~ 1023     |ウェルノウンポート|プロトコル別に予約されサーバで使用される番号            |
|1024 ~ 49151 |登録済みポート   |番号とアプリの関係を登録できる。1024番までは予約されている|
|49152 ~ 65535|ダイナミックポート|自由に使用でき、クライアントが送信元ポートとして使う     |

*well-known*は一般的に使用されるアプリケーションごとに割り当てられている。Webサーバにアクセスしてユーザ側(クライアント)では80番(HTTP)を宛先ポートとしてアクセスし、Webサーバ側では80番のポートを開いて接続を待つ。アプリケーション毎に予めポート番号が決められているためクライアントはその番号を宛先に指定することで特定のアプリケーションにアクセスすることができる。サーバからのデータを適切なアプリケーションで受け取るためには、ユーザ側にもポート番号が必要になる。ユーザ側で使用するポート番号は通常アプリケーション同士で重複しないようにOSがランダムに割り当てる。

|ポート|プロトコル   |TCP / UDP|
|-----|-----------|----------|
|20   |FTP-Data   |TCP       |
|21   |FTP        |TCP       |
|22   |SSH        |TCP       |
|23   |Telnet     |TCP       |
|25   |SMTP       |TCP       |
|53   |DNS        |UDP, TCP  |
|67   |DHCP       |UDP       |
|68   |DHCP       |UDP       |
|69   |TFTP       |UDP       |
|80   |HTTP       |TCP       |
|110  |POP3       |TCP       |
|123  |NTP        |UDP       |
|161  |SNMP       |UDP       |
|162  |SNMP(TRAPS)|UDP       |
|443  |HTTPS      |TCP       |
|520  |RIP        |UDP       |

※67 - *Bootstrap Protocol Server*  
※68 - *Bootstrap Protocol Client*

### `TCP`
**TCP**(*Transmission Control Protocol*)は、コネクション型プロトコル。データ送信の前に通信相手とのコネクションを確立する。アプリケーション層からデータを受け取り、ネットワーク層のMTUに適したサイズに分割しTCPセグメントを生成する(**セグメンテーション**)。  
・送信元ポート(16ビット):送信元のポート番号  
・宛先ポート(16ビット):宛先のポート番号  
・シーケンス番号(32ビット):分割されたデータのどのデータ部かを示す番号。受信側で到着したデータの順序制御に使用される  
・確認応答番号(32ビット):データを受信したことを感知し、次に受信したいデータのシーケンス番号を通知する  
・データオフセット(4ビット):TCPヘッダは可変長のため、受信側はこの値によってTCPヘッダの末尾を認識し、データ部分の位置を判断する  
・予約(6ビット):将来の拡張に備えて予約している未使用のフィールド、通常0  
・制御ビット(6ビット):6つのビットで構成され、個々のビットに意味をもたせて様々な制御を行う。各ビットはフラグと呼ぶ  
・ウィンドウ(16ビット):受信側で受信可能なバッファの大きさを受信側に通知するために使用される。単位はオクテット  
・チェックサム(16ビット):TCPヘッダとデータ部のエラーチェックを行う  
・緊急ポインタ(16ビット):緊急処理が必要なデータの場所を示す値。URGビットは1にセットされる  
・オプション(可変長):必要に応じてオプション追加  
・パディング(可変長):オプションを使用した時、TCPヘッダが32ビットの倍数になるように0を挿入して調整する  

|フラグ                |1がセットされたときの意味                                                                |
|---------------------|-------------------------------------------------------------------------------------|
|URG(*Urgent Pointer*)|緊急に処理すべきデータを含んでいる、緊急ポインタフィールドと一緒に使用                           |
|ACK(*Acknowledgment*)|確認応答番号フィールドが有効であることを示す。最初にコネクションを確立するするSYNセグメント以外は常に1|
|PSH(*Push*)          |受信したデータをすぐにアプリケーションを渡す                                                 |
|RST(*Reset*)         |何らかの異常が検出されたため、コネクションの強制切断を要求                                      |
|SYN(*Synchronize*)   |コネクションの確立を要求                                                                  |
|Fin(*Finish*)        |これ以上送信データがないためコネクションの終了を要求                                           |

- コネクションの確立と終了  
アプリケーションのデータ送信を行う前に仮想のコネクションを確立してからデータのやり取りを開始する(**スリーハンドウェイシェイク**)。制御ビットを使用してTCPセグメント3回やり取りし、この時に**シーケンス番号の初期値を設定**する。

1.ホストAからBにコネクション確立を要求(SYNセグメント)  
制御ビット(SYN = 1, ACK = 0)  
初期シーケンス番号:ランダムな値(ex.100)  
確認応答番号:0

2.Aからのコネクションの確立の要求に応え、ホストBからAに対してもコネクション確立を要求(ACK・SYNセグメント)  
制御ビット(SYN = 1, ACK = 1)  
初期シーケンス番号:ランダムな値(ex.300)  
確認応答番号:受信した時のシーケンス番号 + 1

3.ホストAはからのコネクション確立の要求に応える(ACKセグメント)  
制御ビット(SYN = 0, ACK = 1)  
初期シーケンス番号:初期値 + 1(101)  
確認応答番号:受信した時のシーケンス番号 + 1

このあと実際のデータ転送が開始される。データの転送時に使用されるシーケンス番号はそのまま引き継がれる。データの送信が完了した時には、制御ビットのFINフラグによって相手に終了の要求を通知する。ここまでで2つ(上り・下り)の仮想的なコネクションが確立される。

4.ホストAはBに対してデータ(504バイト)を送信  
制御ビット:ACK = 1  
シーケンス番号、確認応答番号:3ウェイハンドシェイク直後と同じ値(101, 301)

5.ホストBはAに対してデータ(1,136バイト)を送信  
制御ビット:ACK = 1  
シーケンス番号:4の確認応答番号と同じ番号  
確認応答番号:4のシーケンス番号 + 受信データサイズ(101 + 504 = 605)

6.ホストBはデータの送信完了、コネクションに終了を通知  
制御ビット:ACK = 1, FIN = 1
シーケンス番号:5のシーケンス番号 + 送信データサイズ(301 + 1,136 = 1,437)  
確認応答番号:5の確認応答番号と同じ値(605)

7.ホストBからFINを受信、ホストAは確認応答を送信  
制御ビット:ACK = 1, FIN = 0
シーケンス番号:6の確認応答番号と同じ値(605)
確認応答番号:6のシーケンス番号 + 1(1,438)

8.ホストAからもコネクションの終了を通知  
制御ビット:ACK = 1, FIN = 1  
シーケンス番号、確認応答番号:7と同じ値(605, 1,438)

9.ホストAからFINを受信、ホストBは確認応答を送信
制御ビット:ACK = 1, FIN = 0
シーケンス番号:8の確認応答番号と同じ値(1,438)
確認応答番号:8のシーケンス番号 + 1(606)

コネクション終了時には4回対話してTCPコネクションを正常に終了する。終了の手続きをどちらが先に通知するかはアプリケーション層プロトコルなどによって異なる。

- 順序制御と確認応答  
3ウェイハンドシェイクでコネクションが確立されると、データ転送の段階に入る。データが転送されなかった際の対処のために信頼性確保の制御機能を備えている。1つのTCPセグメントで運べるデータをMSS(*Maximum Segment Size*)とよび、MTU(最大伝送ユニット、フレームデータ)からIPヘッダとTCPヘッダを除いた値になる。MSSは3ウェイハンドシェイクのSYNセグメント送信時に、通信相手のMSSと比較して小さい値を採用する(単位バイト)。TCPは大きなデータを受け取るとMSSに分割して複数のTCPセグメントとして送信する。分割されたデータは受信側でシーケンス番号を使って再構成される(**順序処理**)。受信側からの確認応答によって、相手がデータを完全に受信できたことを認識する。

- 再送制御  
ネットワーク状況によっては1つのセグメントが届かなかったり、データの破損や確認応答を受信できないことがある。これを回避するため、TCPでは再送タイマーを設定し、一定の時間内に確認応答がなければデータを再送信する(**再送制御**)。分割されたデータがバラバラの順序で到着してもシーケンス番号を使用して元のデータを復元できる。

- ウィンドウ制御(フロー制御)  
TCPヘッダには**ウィンドウ**というフィールドがある。受信したデータを一時的に溜めておくバッファ領域のことで、この大きさを**ウィンドウサイズ**と呼ぶ。単位はバイト(オクテット)で、コネクションを確立するときのSYNセグメントで相手に通知している。送信側は受信側から確認応答を待たずにTCPセグメントを連続して送信することができ、ACKが1つでも送られてきたら次のデータを送信できる(**ウィンドウ制御(フロー制御)**)。受信側はデータを受け取ると一時的に受信バッファに保管して次のセグメントを処理する。受信側ではセグメントに対して受信できたことを確認応答で通知し、送信側は確認応答を待たずに送信できるウィンドウを徐々にスライドさせながらデータを送信する(**スライディングウィンドウ**)。

### `UDP`
**UDP**(*User Datagram Protocol*)は、コネクションレス型のプロトコル。TCPのようなコネクションの確立、確認応答、シーケンス番号を浸かった制御序列やフロー制御などの機能はない。ポート番号でアプリケーションを識別してデータを渡すだけで、基本的には何もしない。信頼性が必要な場合はアプリケーション層プロトコルで行われる。TCPでは送信するデータの単位をセグメント、UDPでは**データグラム**と呼ぶ。  
・送信元ポート(16ビット):送信元のポート番号  
・宛先ポート(16ビット):宛先のポート番号  
・長さ(16ビット):UDPヘッダとデータ部の長さを合わせた値をオクテット(8ビット)単位で表したもの  
・チェックサム(16ビット):UDPヘッダとデータ部のエラーチェックを行う

- UDPの用途

---
> `TCP:コネクション型、信頼性あり / 同期された通信`  
> `UDP:コネクションレス型、信頼性なし`

> TCP通信では`最初に3ハンドウェイシェイクを行ってコネクションを確立する`

> TCP通信の信頼性を保証するための機能  
> `順序制御(シーケンス番号)`  
> `再送制御`  
> `輻輳制御`  
> `エラー制御(確認応答)`  
> `ウィンドウ制御(フロー制御)`

> TCPとUDPのヘッダのフィールド  
> 両方のフィールドに含まれる:`送信元ポート / 宛先ポート、チェックサム`  
> TCPヘッダに含まれる:`シーケンス番号`
