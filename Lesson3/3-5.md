# DHCP
TCP / IPアプリケーション層には重要な役割を担うプロトコルが多数ある。DHCPを利用すると個々のコンピュータに固有のIPアドレスを手動で割り当てる必要がなくなる。

### `DHCPの概要`
**DHCP**(*Dynamic Host Configuration Protocol*)はTCP / IP通信に必要なIPアドレスなどの設定情報を自動的に取得するためのプロトコル。ユーザはすぐに自身のコンピュータをインターネットに接続することができる。自宅や会社などにノートパソコンを持ち込んで使用する場合は、移動先でネットワーク設定や、都度手作業で変更する手間が省ける。企業のネットワーク管理者は従業員が使用するコンピュータのIPアドレスなどの設定・管理作業を大幅に簡素化できる。DHCPはUDP上で動作し、ポート番号には67(サーバ)と68(クライアント)を使用し、クライアントサーバモデル(分散処理を行うネットワーク形態)で動作する。  
・DHCPサーバ:設定情報を管理してDHCPクライアントに情報を配信する  
・DHCPクライアント:IPアドレスなどの設定情報をDHCPサーバに要求する

### `DHCPクライアント`
一般的なコンピュータのOSには、DHCPクライアントとして動作するためのプログラムが標準搭載されている。Windowsの場合、設定をすればコンピュータの起動時やLANケーブルの接続時などに自動的にTCP / IP通信に必要な設定情報を取得できる。

### `DHCPサーバ`
DHCPサーバには、*Windows Server 2016*や*Linux*などのサーバOSが搭載されたコンピュータを準備。一般家庭でよく使用されるブロードバンドルータにはDHCPサーバ用ソフトが内蔵され、デフォルトで使用できるように設定されている。コンピュータを接続するだけですぐにインターネットへアクセスすることができる。Ciscoルータ、Catalystスイッチも設定すればDHCPサーバとして利用することができる。複数のクライアントに配布するIPアドレスの範囲は、アドレスプールとして定義しておく。DHCPクライアントに配布可能な情報として一般的なものは以下の通り。  
・IPアドレス  
・サブネットマスク  
・リースの有効期限  
・デフォルトゲートウェイ  
・ドメイン名  
・DNSサーバのIPアドレス  
・NTPサーバのIPアドレス  

### `DHCPの仕組み`
DHCPサーバとDHCPクライアントが同一サブネット上に接続されている場合、クライアントがサーバの設定情報を取得するときにやり取りされるメッセージは4つ。

|メッセージ名   |送信する側  |説明                                                     |
|-------------|----------|---------------------------------------------------------|
|DHCP DISCOVER|クライアント|使用可能なDHCPサーバを探すためのメッセージ                     |
|DHCP OFFER   |サーバ     |DHCPクライアントのDHCP DISCOVERに応答し、設定情報の候補を通知する|
|DHCP REQUEST |クライアント|設定情報を正式に取得するためにDHCPサーバへ要求する               |
|DHCP ACK     |サーバ     |設定情報をDHCPクライアントに提供する                           |

windowsの場合`ipconfig/all`でDHCPサーバから取得した設定情報が割り当てられたことを確認できる

### `DHCPで割り当てるIPアドレス`
DHCPサーバからDHCPクライアントにIPアドレスを配布する方法は2種類。  
・アドレスプールの範囲から動的に割り当てる:クライアントに割り当てできるIPアドレスの範囲をアドレスプールに設定しておいて、クライアントからHCP DISCOVERを受け取った時に、空いている番号を選択して割り当てる。貸し出す時はリース期間を設定する(割り当てたアドレスが使用できないと足りなくなるため)。DHCPサーバがダウンしてもクライアントはリース期間が切れるまで、そのIPアドレスを使用することができる。  
DHCPサーバは割り当てたIPアドレス、クライアントのMACアドレス、リースを管理している。有効期限を過ぎたIPアドレスは別のクライアントに割り当てられる(延長要求を繰り返すことが可能)。  
固定で割り当てる方式は、IPアドレスを変えたくないサーバなどの利用する。この場合は事前に割り当てるIPアドレスとクライアントのMACアドレスを登録しておく必要がある。DHCPサーバは、クライアントからのDHCP DISCOVERメッセージに書き込まれたMACアドレスをチェックして一致した場合には固定で用意しておいたIPアドレスを配布する。

・あらかじめ決まったアドレスを固定で割り当てる

---
> DHCP DISCOVERはブロードキャストで送信されるため、ルータを超えて転送されない。ブロードキャストドメインに存在しない時には`DHCPリレーエージェント`の設定が必要
