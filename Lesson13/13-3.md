# スイッチのセキュリティ機能
スイッチのポートに対する攻撃からホストを保護するために、基本的なセキュリティ対策を実施する必要がある

### `スイッチのポートセキュリティ`
スイッチの物理ポートに許可するMACアドレスを登録し、許可していない送信元MACアドレスのフレームを破棄する機能。ポートセキュリティによって、特定ポートに接続できるのは正規のコンピュータ(MACアドレス)だけに制限し、不正に接続されたコンピュータからのフレームを遮断できる。レイヤ2の制限に基づいて実装できるセキュリティ機能。

- セキュアMACアドレスのタイプ  
ポートセキュリティを有効にしたいポート(セキュアポート)で許可されたMACアドレスのこと。スイッチは以下のMACアドレスのタイプをサポートしている。  
スタティック:手動で登録し、MACアドレスと`running-config`に保存される  
ダイナミック:フレームを受信するごとで動的に送信元MACアドレスがMACアドレステーブルにのみ保存され、スイッチの再起動時に消去される  
スティッキー:フレームを受信することで動的に送信元MACアドレスがMACアドレステーブルと`running-config`に保存される

- スティッキーラーニング  
動的に学習したMACアドレステーブルをスティッキーセキュアMACアドレスに変換することで、`running-config`に保存する。`copy running-config startup-config`コマンドでコンフィギュレーションをNVRAMへ保存するとスイッチの再起動後も情報は失われない。

- セキュリティ違反  
ポートセキュリティは、許可されていない送信元MACアドレスのフレームを違反フレームとして扱う。ポートセキュリティが有効なセキュアポートでは、下記の状況が発生するとセキュリティ違反となる。  
・違反フレームを受信した場合:MACアドレスフレームに最大数のセキュアMACアドレスが保存されている状態で違反フレームを受信すると、セキュリティ違反になる。  
・セキュアMACアドレスが別のセキュアポートで使用された場合:あるセキュアポートで登録されたセキュアMACアドレスアドレスを、同じVLANの別のセキュアポートで送信元MACアドレスのフレームとして受信すると、セキュリティ違反になる。セキュリティ違反が発生した時の対処として次の違反モードがある。</br>

|違反モード     |違反フレームの破棄|SNMPトラップ/Sylogメッセージの送信|違反カウンタの増加|ポートシャットダウン     |
|-------------|---------------|------------------------------|---------------|----------------------|
|protect      |あり            |なし                           |なし           |なし                   |
|restrict     |あり            |あり                           |あり           |なし                   |
|shutdown     |あり            |あり                           |あり           |なし                   |
|shutdown vlan|あり            |あり                           |あり           |違反が発生したVLANのみあり|

- ポートセキュリティの設定  
Catalystスイッチの全てのポートで、ポートセキュリティはデフォルトで無効になっている。</br>
1.アクセスポートまたはトランクポートに設定  
ポートセキュリティを設定できるのは、静的なアクセスポートまたはトランクポートに限られる。スイッチポートを動的にネゴシエーションさせる`dynamic auto`、`dynamic desirable`が設定されたポートはセキュアポートに設定できない。  
**スタティックアクセスポートの設定**  
`(config-if)#switchport mode access`  
**スタティックトランクポートの設定**  
`(config-if)#switchport mode trunk`</br></br>
2.セキュアMACアドレスの最大数を指定  
スイッチポートに対してセキュアMACアドレスの最大数を設定する。スイッチに設定できるセキュアMACアドレスの最大数は、システムで許可されているMACアドレスの最大数によって決まる。設定を省略すると、デフォルトで1が指定される。  
**セキュアMACアドレスの最大数の指定**  
`(config-if)#switchport port-security maximum <value>`  
value:許可されているMACアドレスの最大数を指定(デフォルトは1)</br></br>
3.違反モードの指定  
違反モードを設定することで、セキュリティ違反が発生した時の対処方法を指定できる。設定を省略すると、デフォルトはshutdownモードになる。  
**違反モードの指定**  
`(config-if)#switchport port-security violation {protect | restrict | shutdown vlan}`</br></br>
4.セキュアMACアドレスの指定  
セキュアMACアドレスを手動で設定した場合、アドレスタイプはスタティックになる。  
**セキュアMACアドレスの主導設定**  
`(config-if)#switchport port-security mad-address <mac-address>`  
このコマンドを設定すると、スティッキーラーニングが有効になり、動的に学習したMACアドレスが`running-config`に保存される。スティッキーラーニングを利用すると、管理者は正規ユーザのMACアドレスを調べて手動で設定する手間が省けて作業効率が向上する。  
**スティッキーラーニングの有効化**  
`(config-if)#switchport port-security mad-address sticky`</br></br>
5.ポートセキュリティの有効化  
ここまで設定が完了したら、ポートセキュリティを有効化する。  
**ポートセキュリティの有効化**  
`(config-if)#switchport port-security`

- ポートセキュリティの検証  
設定したポートセキュリティの確認には下記コマンドを使用する。  
`show port-security`  
`show port-security interface`  
`show port-security address`  
`show port-security status`  
**show port-security**コマンドは、セキュアポートの状態を表示する。コマンドの後ろにインターフェイス名を指定すると、より詳細な情報を表示できる。  
**ポートセキュリティの状態を表示(mode:#, >)**  
`#show port-security [interface <interface-id>]`  
・表示される情報:  
Secure Port:ポートセキュリティが有効なポート(セキュアポート)  
MaxSecureAddr:セキュアMACアドレスの最大数  
CurrentAddr:現在の登録済みセキュアMACアドレス数  
SecureViolation:違反カウント  
Security Action:違反モード  
・詳細情報の表示:  
1.ポートセキュリティは有効。disablesは無効  
2.ポートは正常にアップしている  
3.違反モード  
4.セキュアMACアドレスのエージングタイム。デフォルトは0min  
5.セキュアMACアドレスのエージングタイプ。Absoluteはエージングタイムで指定した時間が経過した後に削除(通信中であっても)。デフォルトはAbsolute  
6.セキュアMACアドレスの最大数  
7.現在の登録済みセキュアMACアドレス数  
8.スタティックに登録されたMACアドレス数  
9.スタティックラーニングによって学習されたMACアドレス数  
10.違反カウント。0はまだ違反フレームを受信していないことを表す  
**セキュアMACアドレスの表示(mode:#)**  
`#show port-security address`  
セキュリティ違反によってerr-disabled状態になったポートは、`show interfaces`コマンドで確認できる。

- err-disabled状態からの回復  
Catalystスイッチは有効なポートでエラー状態を検出した場合、そのポートはIOSによってerr-disabledという状態としてシャットダウンし、ポートLEDを消灯する。err-disabled状態のポートは、フレームを送受信できない。原因を復旧してもデフォルトでは状態は変わらない。ポートを再度有効にしてフレーム転送を再開するには、コマンドで手動または自動で回復する必要がある。  
**err-disabled状態からの手動回復**  
`(config-if)#shutdown`  
`(config-if)#no shutdown`  
**err-disabled状態からの自動回復**  
`(config)#errdisable recovery cause {all | <cause-name>}`  
all:全ての原因からの自動回復  
cause-name:特定の原因を指定。ポートセキュリティ違反の場合はpsecure-violation  
自動回復が有効になると、そのポートは一定秒数が経過すると自動的に回復する。自動回復までの時間を変更するためには、コマンドを使用する。  
**自動回復のためのインターバル設定**  
`(config)#errdisable recovery interval <timer-interval>`  
timer-interval:自動回復するまでの経路時間を指定(単位はs)。デフォルトは300s  
**show errdisable recovery**コマンドを使用すると、各ポートが自動回復されるまでに必要な時間を確認できる。なお、ポートを自動回復してもエラーの原因が解決していない場合は、再度err-disabled状態となり繰り返される。

### `未使用ポートの保護`
スイッチはトランスペアレントなブリッジングを提供する「集線装置」の役割を果たす。Catalystスイッチの全てのポートは最初から有効(no shutdown)の状態で、スイッチポートにケーブルを繋ぐと接続した端末のフレームを転送する。このため、攻撃者によって未使用ポートにコンピュータを接続されてもリンクアップする。シスコでは使用していない全てのスイッチポートに対してデフォルト設定を以下のように変更することを推奨している(全てインターフェイスコンフィギュレーションモード)。`shutdown`コマンドで物理層レベルで無効化されるが、`no shutdown`コマンドで有効化された時のために、他の設定もしておくと良い。
|コマンド                           |説明                                                              |
|----------------------------------|-----------------------------------------------------------------|
|`shutdown`                        |ポートを管理的に無効化する。物理層レベルでポートをダウン状態にすることが可能  |
|`switchport mode access`          |明示的なアクセスポートにする。不要なトランクポートになることを防ぐ           |
|`switchport access vlan <vlan-id>`|未使用のVANを割り当てる(デフォはVLAN1)。使用している全VLANへのアクセスを防ぐ|

---
> MACアドレスを利用するポートセキュリティはスイッチの機能。ルータには設定できない
